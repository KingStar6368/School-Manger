@using School_Manager.Core.Services.Interfaces
@using School_Manger.Extension
@using School_Manger.Models.PageView
@inject IShiftService ShiftService;
@model AdminDriver
@{
    ViewData["Title"] = "جزئیات راننده";
    Layout = "_AdminLayout";
}

<div class="card bg-dark text-white mb-4 shadow-lg rounded-4 border-primary border-2">
    <div class="card-header bg-primary text-white rounded-top-4">
        <h3 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>@ViewData["Title"]</h3>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <!-- Driver Info -->
            <div class="col-md-6">
                <h5 class="border-bottom pb-2 mb-3 text-info">اطلاعات راننده</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-dark text-white border-0">👤 <strong>نام کامل:</strong> @Model.Driver.Name @Model.Driver.LastName</li>
                    <li class="list-group-item bg-dark text-white border-0">🆔 <strong>کد ملی:</strong> @Model.Driver.NationCode</li>
                    <li class="list-group-item bg-dark text-white border-0">👨‍👦 <strong>نام پدر:</strong> @Model.Driver.FutherName</li>
                    <li class="list-group-item bg-dark text-white border-0">🏦 <strong>بانک:</strong> @* @Model.Driver.BankAccount *@</li>
                    <li class="list-group-item bg-dark text-white border-0">🔢 <strong>شماره حساب:</strong> @Model.Driver.BankNumber</li>
                    <li class="list-group-item bg-dark text-white border-0">🎂 <strong>تاریخ تولد:</strong> @Model.Driver.BirthDate.ToPersianString()</li>
                    <li class="list-group-item bg-dark text-white border-0">⭐ <strong>امتیاز:</strong> <span class="badge bg-success">@Model.Driver.Rate</span></li>
                    <li class="list-group-item bg-dark text-white border-0">⚠️ <strong>اخطارها:</strong> <span class="badge bg-warning text-dark">@Model.Driver.Warnning</span></li>
                    <li class="list-group-item bg-dark text-white border-0">🏠 <strong>آدرس:</strong> @Model.Driver.Address</li>
                    <li class="list-group-item bg-dark text-white border-0">🎓 <strong>تحصیلات:</strong> @Model.Driver.Education</li>
                    <li class="list-group-item bg-dark text-white border-0">🚘 <strong>شماره گواهی:</strong> @Model.Driver.CertificateId</li>
                </ul>
            </div>

            <!-- Car Info -->
            <div class="col-md-6">
                <h5 class="border-bottom pb-2 mb-3 text-info">اطلاعات خودرو</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-dark text-white border-0">🚗 <strong>مدل:</strong> @Model.Driver.Car.Name</li>
                    <li class="list-group-item bg-dark text-white border-0">🎨 <strong>رنگ:</strong> @Model.Driver.Car.Color</li>
                    <li class="list-group-item bg-dark text-white border-0">🔢 <strong>پلاک:</strong> @Html.Partial("_CarPlate", Model.Driver.Car.PlateNumber)</li>
                </ul>
            </div>
        </div>
        <div class="mb-6">
            <label class="form-label">شیفت‌های قابل انتخاب و تعداد صندلی:</label>
            <input type="text" id="shiftFilter" class="form-control mb-2" placeholder="جستجو شیفت..." onkeyup="filterShifts()" />
            <table class="table table-bordered table-dark table-striped" id="shiftTable">
                <thead>
                    <tr>
                        <th>نام شیفت</th>
                        <th>زمان شروع</th>
                        <th>زمان پایان</th>
                        <th>تعداد مسافر / تعداد کل صندلی</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var shift in ShiftService.GetAllDriverShifts(Model.Driver.Id))
                    {
                        var PassangerCount = ShiftService.GetDriverShift(shift.Id, Model.Driver.Id).Passenger?.Count ?? 0;
                        <tr>
                            <form asp-action="Details">
                                <input name="id" type="hidden" value="@Model.Driver.Id"/>
                                <input name="ShiftId" type="hidden" value="@shift.Id" />
                                <td>@shift.Name</td>
                                <td>@shift.Start.ToString("HH:mm")</td>
                                <td>@shift.End.ToString("HH:mm")</td>
                                <td>@PassangerCount / @ShiftService.GetDriverShifts(Model.Driver.Id).FirstOrDefault(x => x.ShiftRef == shift.Id).Seats </td>
                                <td><button class="bg-success text-white" type="submit">مشاهده مسافرین شیفت</button></td>
                            </form>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="mt-4">
            <a asp-action="Index" class="btn btn-outline-light rounded-4">
                <i class="bi bi-arrow-right"></i> بازگشت به لیست
            </a>
        </div>
    </div>
</div>

<!-- Passenger List -->
<div class="card bg-dark shadow-lg rounded-4 border-white border-2">
    <div class="card-header bg-secondary text-white rounded-top-4">
        <h4><i class="bi bi-people-fill me-2"></i>لیست مسافرین</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover align-middle text-center">
                <thead class="table-light text-dark">
                    <tr>
                        <th>شناسه</th>
                        <th>نام</th>
                        <th>نام خانوادگی</th>
                        <th>سال تحصیلی</th>
                        <th>آدرس رفت</th>
                        <th>آدرس برگشت</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var passanger in Model.Passanger)
                    {
                        <tr>
                            <td>@passanger.Id</td>
                            <td>@passanger.FirstName</td>
                            <td>@passanger.LastName</td>
                            <td>@passanger.Class</td>
                            <td>@passanger.Path?.Location1?.Address</td>
                            <td>@passanger.Path?.Location2?.Address</td>
                            <td>
                                <form asp-controller="School" asp-action="Details">
                                    <input type="hidden" name="id" value="@passanger.SchoolId" />
                                    <button class="btn btn-sm btn-outline-info" type="submit">
                                        <i class="bi bi-file-earmark-text"></i> نمایش مدرسه
                                    </button>
                                </form>
                                <form asp-controller="Parents" asp-action="CreateBill" method="post" class="d-inline">
                                    <input name="ChildId" type="hidden" value="@passanger.Id" />
                                    <button class="btn btn-sm btn-outline-warning" type="submit">
                                        <i class="bi bi-file-earmark-text"></i> صدور قبض
                                    </button>
                                </form>
                                <form asp-action="DeletePassanger"
                                      class="btn text-black bg-danger btn-sm btn-outline-light rounded-pill shadow-sm title="حذف">
                                    <input hidden name="ChildId" value="@passanger.Id" />
                                    <input hidden name="DriverId" value="@Model.Driver.Id" />
                                    <input type="submit" class="bi bi-trash" style="background-color:transparent" value="🗑️ حذف از لیست" />
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
