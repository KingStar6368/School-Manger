@using School_Manger.Models.PageView;
@model BillCalViewModel
@{
    ViewData["Title"] = "📄 صدور قبض";
    Layout = "_AdminLayout";
}
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        margin-bottom: 20px;
        border: 2px solid #ccc;
        border-radius: 10px;
    }
</style>

<div class="container mt-4" dir="rtl">
    <div class="card shadow-lg rounded-4 border-primary mb-4">
        <div class="card-header bg-primary bg-gradient d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold">
                📄 صدور قبض اقساطی
            </h4>
            <a asp-controller="Parents" asp-action="Index" class="btn btn-outline-light shadow-sm fw-bold">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
        </div>
        <div class="card-body">
            <form id="billInstallmentForm" method="post" asp-action="BillCalPerView">
                <input type="hidden" asp-for="@Model.Installment.ServiceContractRef" />
                <input type="hidden" id="Lat1" value="@Model.Location.Location1.Latitude" />
                <input type="hidden" id="Lng1" value="@Model.Location.Location1.Longitude" />
                <input type="hidden" id="Lat2" value="@Model.Location.Location2.Latitude" />
                <input type="hidden" id="Lng2" value="@Model.Location.Location2.Longitude" />
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">تعداد قسط</label>
                        <input asp-for="@Model.Installment.InstallmentCount" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">مبلغ ماهیانه (تومان)</label>
                        <input asp-for="@Model.Installment.Price" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">مهلت پرداخت (روز)</label>
                        <input asp-for="@Model.Installment.DeadLine" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">تاریخ اولین قبض</label>
                        <input asp-for="@Model.Installment.StartDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">تاریخ آخرین قبض</label>
                        <input asp-for="@Model.Installment.EndDate" type="date" class="form-control" />
                    </div>
                </div>
                <div class="mt-4">
                    <button type="submit" class="btn btn-warning fw-bold">پیش نمایش قبض ها</button>
                </div>
            </form>
        </div>
    </div>

    @if (Model?.Bills != null && Model.Bills.Any())
    {
        <div class="card shadow-lg rounded-4 border-success mb-4">
            <div class="card-header bg-success bg-gradient text-white fw-bold">
                پیش نمایش قبض های صادر شده
            </div>
            <div class="card-body">
                <form method="post" asp-action="BillCal">
                    <input type="hidden" name="ServiceContractRef" value="@Model.Installment.ServiceContractRef" />
                    <input type="hidden" name="InstallmentCount" value="@Model.Installment.InstallmentCount" />
                    <input type="hidden" name="Price" value="@Model.Installment.Price" />
                    <input type="hidden" name="DeadLine" value="@Model.Installment.DeadLine" />
                    <input type="hidden" name="StartDate" value="@Model.Installment.StartDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="EndDate" value="@Model.Installment.EndDate.ToString("yyyy-MM-dd")" />
                    <table class="table table-bordered table-striped text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>عنوان قبض</th>
                                <th>مبلغ کل</th>
                                <th>تاریخ سررسید</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var bill in Model.Bills)
                        {
                            <tr>
                                <td>@bill.Name</td>
                                <td>@bill.TotalPrice.ToString("N0")</td>
                                <td>@bill.BillExpiredTimePer</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-success fw-bold">صدور نهایی قبض ها</button>
                </form>
            </div>
        </div>
    }
</div>

<div class="card">
    <div class="card-header bg-info">
        <h3>محاسبه قیمت بر اساس کیلو متر</h3>
    </div>
    <div class="card-body bg-dark row g-3">
        <div class="col-md-4">
            <label class="form-label fw-bold text-white">مبلغ بر اساس ۱ کیلومتر (تومان)</label>
            <input class="form-control" type="number" id="Price" placeholder="مبلغ بر اساس کیلومتر تومان"/>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold text-white">کیلومتر</label>
            <input class="form-control" type="number" id="Km" placeholder="کیلومتر"/>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold text-white">مبلغ محاسبه شده یک مسیر</label>
            <input class="form-control" type="number" id="PriceLbl" placeholder="مبلغ محاسبه شده" />
            <label class="form-label fw-bold text-white">مبلغ محاسبه شده رفت و برگشت</label>
            <input class="form-control" type="number" id="PriceLblTow" placeholder="مبلغ محاسبه شده" />
            <label class="form-label text-white fw-bold">مبلغ محاسبه شده ماهانه</label>
            <input class="form-control" type="number" id="PriceLblMoth" placeholder="مبلغ محاسبه شده" />
        </div>
        <button class="form-control bg-info col-md-4" onclick="Calculator()">محاسبه</button>
        <label id="info" class="text-white"></label>
        <div id="map" />
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function Calculator(){
        Km = parseFloat(document.getElementById('Km').value);
        Price = parseFloat(document.getElementById('Price').value);
        document.getElementById('PriceLbl').value = (Price * Km).toFixed(2);
        document.getElementById('PriceLblTow').value = (Price * Km).toFixed(2) * 2;
        document.getElementById('PriceLblMoth').value = ((Price * Km).toFixed(2) * 2)*30;
    }
    document.addEventListener('DOMContentLoaded', async function () {
        const map = L.map("map").setView([34.09, 49.678], 16);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
        }).addTo(map);

        const from = {
            Lat: parseFloat(document.getElementById("Lat1").value),
            Lng: parseFloat(document.getElementById('Lng1').value)
        };
        const to = {
            Lat: parseFloat(document.getElementById("Lat2").value),
            Lng: parseFloat(document.getElementById('Lng2').value)
        };

        const url = `http://localhost:5000/Route?fromLat=${from.Lat}&fromLon=${from.Lng}&toLat=${to.Lat}&toLon=${to.Lng}`;
        L.marker({lat:from.Lat,lng:from.Lng}).addTo(map).bindPopup('<div class="bg-success">موقعیت خانه</div>').openPopup();
        L.marker({lat:to.Lat,lng:to.Lng}).addTo(map).bindPopup('<div class="bg-danger">موقعیت مدرسه</div>').openPopup();
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`API error: ${res.status}`);

            const data = await res.json();

            // Draw polyline
            const latlngs = data.route.map(coord => [coord[0], coord[1]]);
            const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
            map.fitBounds(polyline.getBounds());

            // Show distance and time
            document.getElementById('info').textContent =
                `مسافت: ${data.distance_km.toFixed(2)} کیلومتر، زمان تقریبی: ${data.estimated_time_min.toFixed(2)} دقیقه`;
            document.getElementById('Km').value = parseFloat(data.distance_km).toFixed(2);

        } catch (err) {
            document.getElementById('info').textContent = 'خطا در دریافت مسیر: ' + err.message;
        }
    });
</script>
