@using SMS.Base
@using School_Manger.Models.PageView
@using School_Manager.Core.Classes
@inject IAppConfigService ConfigService
@model BillCalViewModel
@{
    ViewData["Title"] = "📄 صدور قبض";
    Layout = "_AdminLayout";
}
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        margin-bottom: 20px;
        border: 2px solid #ccc;
        border-radius: 10px;
    }
</style>

<div class="container mt-4" dir="rtl">
    <div class="card shadow-lg rounded-4 border-primary mb-4">
        <div class="card-header bg-primary bg-gradient d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold">
                📄 صدور قبض اقساطی
            </h4>
            <a asp-controller="Parents" asp-action="Index" class="btn btn-outline-light shadow-sm fw-bold">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
        </div>
        <div class="card-body">
            <form id="billInstallmentForm" method="post" asp-action="BillCalPerView">
                <input type="hidden" asp-for="@Model.Installment.ServiceContractRef" />
                <input type="hidden" id="Lat1" value="@Model.Location.Location1.Latitude" />
                <input type="hidden" id="Lng1" value="@Model.Location.Location1.Longitude" />
                <input type="hidden" id="Lat2" value="@Model.Location.Location2.Latitude" />
                <input type="hidden" id="Lng2" value="@Model.Location.Location2.Longitude" />
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">تعداد قسط</label>
                        <input asp-for="@Model.Installment.InstallmentCount" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">مبلغ ماهیانه (ریال)</label>
                        <input type="text" asp-for="@Model.Installment.Price" class="form-control price-separator" />
                    </div> 
                    <div class="col-md-4">
                        <label class="form-label fw-bold">مهلت پرداخت (روز)</label>
                        <input asp-for="@Model.Installment.DeadLine" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">📅 تاریخ اولین قبض</label>
                        <input name="PreStartDate" type="text" class="form-control persian-date bg-secondary text-white" placeholder="انتخاب تاریخ" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">📅 تاریخ آخرین قبض</label>
                        <input name="PreEndDate" type="text" class="form-control persian-date bg-secondary text-white" placeholder="انتخاب تاریخ" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>
                </div>
                <div class="mt-4">
                    <button type="submit" class="btn btn-warning fw-bold">پیش نمایش قبض ها</button>
                </div>
            </form>
        </div>
    </div>

    @if (Model?.Bills != null && Model.Bills.Any())
    {
        <div class="card shadow-lg rounded-4 border-success mb-4">
            <div class="card-header bg-success bg-gradient text-white fw-bold">
                پیش نمایش قبض های صادر شده
            </div>
            <div class="card-body">
                <form method="post" asp-action="BillCal">
                    <input type="hidden" name="ServiceContractRef" value="@Model.Installment.ServiceContractRef" />
                    <input type="hidden" name="InstallmentCount" value="@Model.Installment.InstallmentCount" />
                    <input type="hidden" name="Price" value="@Model.Installment.Price" />
                    <input type="hidden" name="DeadLine" value="@Model.Installment.DeadLine" />
                    <input type="hidden" name="StartDate" value="@Model.Installment.StartDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="EndDate" value="@Model.Installment.EndDate.ToString("yyyy-MM-dd")" />
                    <table class="table table-bordered table-striped text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>عنوان قبض</th>
                                <th>مبلغ کل</th>
                                <th>تاریخ سررسید</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var bill in Model.Bills)
                        {
                            <tr>
                                <td>@bill.Name</td>
                                <td>@School_Manager.Core.Classes.Helper.FormatPrice(bill.TotalPrice)</td>
                                <td>@bill.BillExpiredTimePer</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-success fw-bold">صدور نهایی قبض ها</button>
                </form>
            </div>
        </div>
    }
</div>

<div class="card">
    <div class="card-header bg-info">
        <h3>محاسبه قیمت بر اساس کیلو متر</h3>
    </div>
    <div class="card-body bg-dark row g-3">
        <div class="col-md-4">
            <label class="form-label fw-bold text-white">کیلومتر</label>
            <input class="form-control" type="number" id="Km" placeholder="کیلومتر"/>
            <input hidden class="form-control" type="number" id="Km1" placeholder="کیلومتر"/>
            <input hidden class="form-control" type="number" id="Km2" placeholder="کیلومتر"/>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold text-white">مبلغ محاسبه شده</label>
            <input class="form-control price-separator" type="number" id="PriceLbl" placeholder="مبلغ محاسبه شده" />
        </div>
        <button class="form-control bg-info col-md-4" onclick="Calculator()">محاسبه</button>
        <label id="info" class="text-white"></label>
        <label id="info2" class="text-white"></label>
        <div id="map" />
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function Calculator(){
        var Km1 = parseFloat(document.getElementById('Km1').value);
        var Km2 = parseFloat(document.getElementById('Km2').value);
        var totalkm = ((Km1 + Km2)/2)+1;
        document.getElementById('Km').value = totalkm;
        // Call backend to get price by km
alert(totalkm);
        fetch('/Admin/Parents/GetPriceByKm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name=__RequestVerificationToken]')?.value || ''
            },
            body: JSON.stringify(totalkm)
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('PriceLbl').value = data.price;
        })
        .catch(err => {
            document.getElementById('PriceLbl').value = '';
        });
    }
    function formatNumberWithCommas(x) {
        if (!x) return '';
        x = x.toString().replace(/[^\d]/g, '');
        return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function unformatNumber(x) {
        return x.replace(/,/g, '');
    }
    document.addEventListener('DOMContentLoaded', async function () {
        const map = L.map("map").setView([34.09, 49.678], 16);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
        }).addTo(map);

        const from = {
            Lat: parseFloat(document.getElementById("Lat1").value),
            Lng: parseFloat(document.getElementById('Lng1').value)
        };
        const to = {
            Lat: parseFloat(document.getElementById("Lat2").value),
            Lng: parseFloat(document.getElementById('Lng2').value)
        };

        let url = `/Admin/Parents/GetKm?fromLat=${from.Lat}&fromLon=${from.Lng}&toLat=${to.Lat}&toLon=${to.Lng}`;
        L.marker({lat:from.Lat,lng:from.Lng}).addTo(map).bindPopup('<div class="bg-success">موقعیت خانه</div>').openPopup();
        L.marker({lat:to.Lat,lng:to.Lng}).addTo(map).bindPopup('<div class="bg-danger">موقعیت مدرسه</div>').openPopup();
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`API error: ${res.status}`);

            let data = await res.json();

            // If backend sent a JSON string, parse it again
            if (typeof data === "string") {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    console.error("Invalid JSON string from server:", data);
                }
            }

            // Draw polyline
            const latlngs = data.route.map(coord => [coord[0], coord[1]]);
            const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
            map.fitBounds(polyline.getBounds());

            // Show distance and time
            document.getElementById('info').textContent =
                `مسافت رفت: ${data.distance_km.toFixed(2)} کیلومتر، زمان تقریبی: ${data.estimated_time_min.toFixed(2)} دقیقه`;
            document.getElementById('Km1').value = parseFloat(data.distance_km).toFixed(2);

        } catch (err) {
            document.getElementById('info').textContent = 'خطا در دریافت مسیر: ' + err.message;
        }
        // مسیر برگشت
        url = `/Admin/Parents/GetKm?fromLat=${to.Lat}&fromLon=${to.Lng}&toLat=${from.Lat}&toLon=${from.Lng}`;
        L.marker({lat:from.Lat,lng:from.Lng}).addTo(map).bindPopup('<div class="bg-success">موقعیت خانه</div>').openPopup();
        L.marker({lat:to.Lat,lng:to.Lng}).addTo(map).bindPopup('<div class="bg-danger">موقعیت مدرسه</div>').openPopup();
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`API error: ${res.status}`);

            let data = await res.json();

            // If backend sent a JSON string, parse it again
            if (typeof data === "string") {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    console.error("Invalid JSON string from server:", data);
                }
            }

            // Draw polyline
            const latlngs = data.route.map(coord => [coord[0], coord[1]]);
            const polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);
            map.fitBounds(polyline.getBounds());

            // Show distance and time
            document.getElementById('info2').textContent =
                `مسافت بازگشت: ${data.distance_km.toFixed(2)} کیلومتر، زمان تقریبی: ${data.estimated_time_min.toFixed(2)} دقیقه`;
            document.getElementById('Km2').value = parseFloat(data.distance_km).toFixed(2);

        } catch (err) {
            document.getElementById('info2').textContent = 'خطا در دریافت مسیر: ' + err.message;
        }
        document.querySelectorAll('.price-separator').forEach(function(input) {
            input.addEventListener('input', function(e) {
                var cursorPos = input.selectionStart;
                var originalLength = input.value.length;
                var unformatted = unformatNumber(input.value);
                if (unformatted) {
                    input.value = formatNumberWithCommas(unformatted);
                } else {
                    input.value = '';
                }
                var newLength = input.value.length;
                input.setSelectionRange(cursorPos + (newLength - originalLength), cursorPos + (newLength - originalLength));
            });
            // On form submit, unformat the value
            input.form && input.form.addEventListener('submit', function() {
                input.value = unformatNumber(input.value);
            });
        });
    });
</script>
