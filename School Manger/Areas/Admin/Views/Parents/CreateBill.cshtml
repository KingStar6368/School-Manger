@using School_Manger.Extension
@using School_Manager.Core.ViewModels.FModels
@model ChildInfo
@{
    ViewData["Title"] = "📄 صدور قبض";
    Layout = "_AdminLayout";
}

<div class="container mt-4 text-white" dir="rtl">
    <!-- 💳 BillDto Creation Form -->
    <div class="card bg-dark text-white shadow-lg rounded-4 border-primary mb-4">
        <div class="card-header bg-primary bg-gradient d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold">
                📄 صدور قبض برای: <span class="text-warning">@Model.FirstName @Model.LastName</span>
            </h4>
            <a asp-controller="Parents" asp-action="Index" class="btn btn-outline-light shadow-sm fw-bold">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
        </div>
        <div class="card-body">

            <div class="col-md-5">
                <label class="form-label fw-bold">❓پرداخت شده</label>
                <input type="checkbox" id="isPaidCheckbox" name="IsPaid" class="form-check-input bg-dark text-white shadow-sm" onchange="togglePaymentFields()" />
            </div>
            <form asp-action="MakeBill" method="post" id="BillGruop">
                <input type="hidden" name="ChildId" value="@Model.Id" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">📝 عنوان قبض</label>
                        <input type="text" name="Name" class="form-control bg-dark text-white shadow-sm" placeholder="مثلاً شهریه مهر ماه" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">💰 مبلغ کل (تومان)</label>
                        <input type="number" name="TotalPrice" class="form-control bg-dark text-white shadow-sm" required />
                    </div>
                    <div class="col-md-6">
                        <label id="LblEndTime" class="form-label fw-bold">📆 مهلت قبض</label>
                        <input name="EndTime" class="persian-date form-control bg-secondary text-white" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">📆 مهلت پرداخت</label>
                        <input name="Estimate" class="persian-date form-control bg-secondary text-white" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">💵 قبض پیش پرداخت</label>
                        <input type="checkbox" id="IsPerBill" name="IsPerBill" class="form-check-input bg-dark text-white shadow-sm" onchange="toggleisperbill()" />
                    </div>
                    <div id="PreStart" style="display:none" class="col-md-6">
                        <label class="form-label fw-bold">📆 تاریخ شروع قرارداد</label>
                        <input name="StartTime" class="persian-date form-control bg-secondary text-white" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success fw-bold me-2 shadow-sm">
                            📤 صدور قبض
                        </button>
                        <a asp-controller="Parents" asp-action="Index" class="btn btn-secondary fw-bold shadow-sm">
                            🔙 بازگشت
                        </a>
                    </div>
                </div>
            </form>
            <form asp-action="PayBill" method="post" id="paymentFields" style="display:none;">
                <input type="hidden" name="ChildId" value="@Model.Id" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">🆔 شماره قبض</label>
                        <input type="number" id="BillId" name="BillId" class="form-control bg-dark text-white shadow-sm" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">🔖 کد رهگیری (اختیاری)</label>
                        <input type="text" name="TrackCode" class="form-control bg-dark text-white shadow-sm" placeholder="کد رهگیری پرداخت" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">💳 روش پرداخت</label>
                        <select name="PaymentType" class="form-select bg-dark text-white shadow-sm" required>
                            <option value="">-- انتخاب کنید --</option>
                            <option value="Cash">💵 نقدی</option>
                            <option value="Pos">💳 دستگاه پوز</option>
                            <option value="Internet">🌐 اینترنتی</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">💵 مبلغ پرداخت شده</label>
                        <input type="number" id="PayPrice" name="PaidPrice" class="form-control bg-dark text-white shadow-sm" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">📆زمان پرداخت</label>
                        <input name="PiadTime" class="persian-date form-control bg-secondary text-white" required />
                        <input type="hidden" class="gregorian-date" />
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success fw-bold me-2 shadow-sm">
                            📤 ثبت خرید
                        </button>
                        <a asp-controller="Parents" asp-action="Index" class="btn btn-secondary fw-bold shadow-sm">
                            🔙 بازگشت
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- 📜 Bills List -->
    <div class="card bg-dark text-white shadow-lg rounded-4 border-primary">
        <div class="card-header bg-primary bg-gradient fw-bold">
            📜 لیست قبوض <span class="text-warning">@Model.FirstName @Model.LastName</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                @if(Model.Bills != null && Model.Bills.Count > 0){
                    <table class="table table-dark table-bordered table-hover text-center align-middle mb-0">
                        <thead class="table-light text-dark">
                            <tr>
                                <th>🔢 ردیف</th>
                                <th>🆔 شناسه قبض</th>
                                <th>🆔 شناسه قرارداد</th>
                                <th>📄 نام قبض</th>
                                <th>💵 مبلغ کل</th>
                                <th>💳 مبلغ پرداخت شده</th>
                                <th>✅ وضعیت</th>
                                <th>⏰ زمان پرداخت/مهلت</th>
                                <th>⚙️ عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Bills.Count; i++)
                            {
                                var bill = Model.Bills[i];
                                <tr onclick="BillRowId(@bill.Id,@bill.TotalPrice - @bill.PaidPrice)">
                                    <td>@(i + 1)</td>
                                    <td>@bill.Id</td>
                                    <td>@bill.ContractId</td>
                                    <td>@bill.Name</td>
                                    <td>@bill.TotalPrice.ToString("N0")</td>
                                    <td>@bill.PaidPrice.ToString("N0")</td>
                                    <td>
                                        @if (bill.HasPaid)
                                        {
                                            <span class="badge bg-success rounded-pill fw-bold shadow-sm">✅ پرداخت شده</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger rounded-pill fw-bold shadow-sm">❌ @bill.Status</span>
                                        }
                                    </td>
                                    <td>
                                        @(bill.HasPaid
                                            ? DateConverter.ToPersianString((DateTime)bill.PaidTime)
                                            : DateConverter.ToPersianString(bill.BillExpiredTime))
                                    </td>
                                    <td>
                                    <a asp-action="DeleteBill" asp-route-id="@bill.Id"
                                       class="btn text-black bg-danger btn-sm btn-outline-light rounded-pill shadow-sm title="حذف">
                                        <i class="bi bi-trash"></i> 🗑️ حذف
                                    </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }else{
                    <div class="alert alert-warning text-center fw-bold">🚫 هیچ قبضی ثبت نشده است.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function togglePaymentFields() {
            var checkbox = document.getElementById('isPaidCheckbox');
            var paymentFields = document.getElementById('paymentFields');
            var BillGruop = document.getElementById('BillGruop');
            if (checkbox.checked) {
                paymentFields.style.display = 'flex';
                BillGruop.style.display = 'none';

                paymentFields.querySelectorAll('input[required], select[required]').forEach(function(input) {
                    input.required = true;
                });
                BillGruop.querySelectorAll('input[required], select[required]').forEach(function(input) {
                    input.required = false;
                });
            } else {
                paymentFields.style.display = 'none';
                BillGruop.style.display = 'flex';
                paymentFields.querySelectorAll('input, select').forEach(function(input) {
                    input.required = false;
                });
                BillGruop.querySelectorAll('input[required], select[required]').forEach(function(input) {
                    input.required = true;
                });
            }
        }
        function toggleisperbill(){
            var checkbox = document.getElementById('IsPerBill');
            var detial = document.getElementById('PreStart');
            var Lbl = document.getElementById('LblEndTime')
            if(checkbox.checked)
            {
                detial.style.display = 'flex';
                detial.querySelectorAll('input, select').forEach(function(input) {
                    input.required = true;
                });
                Lbl.textContent = "📆 تاریخ اتمام قرارد";
            }
            else{
                detial.style.display = 'none';
                detial.querySelectorAll('input, select').forEach(function(input) {
                    input.required = false;
                });
                Lbl.textContent = "📆 مهلت قبض";
            }
        }
        function BillRowId(Id,TotalPrice){
            document.getElementById('BillId').value = Id;
            document.getElementById('PayPrice').value = TotalPrice;
        }
    </script>
}