<!-- 👨‍👩‍👧‍👦 Parent Details Page -->
@using School_Manger.Models.PageView
@using School_Manger.Extension
@model AdminParent

@{
    ViewData["Title"] = "📋 جزئیات والدین";
    Layout = "_AdminLayout";
}

<!-- Leaflet Stylesheet -->
<link rel="stylesheet" href="~/Leaflet/leaflet.css" />

<style>
    #routeMap {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
    }

    .leaflet-container {
        font-family: inherit;
        background-color: #1a1a1a;
    }

    .badge {
        font-size: 1rem;
        padding: 0.6em 1em;
    }

    .card {
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .table th {
        border-bottom: 2px solid #495057;
    }

    /* Custom marker styles */
    .origin-marker, .destination-marker {
        font-weight: bold;
        text-align: center;
    }

    /* Animation for table rows */
    .table-hover tbody tr:hover {
        background-color: rgba(255,255,255,0.1);
        transform: scale(1.01);
        transition: all 0.3s ease;
    }

    /* Pulse animation for map markers */
    .pulse-effect {
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.1);
            opacity: 0.7;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<div class="container-fluid bg-dark text-white rounded shadow p-4" dir="rtl">
    <!-- 👨‍👩 Parent Info -->
    <div class="card mb-4 border-primary shadow-lg">
        <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-person-badge fs-4 me-2"></i>اطلاعات والدین
            </h4>
            <span class="badge bg-light text-dark fs-6">
                <i class="bi bi-people me-1"></i>@Model.Parent.Children.Count فرزند
            </span>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4 mb-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="bi bi-person-circle text-warning fs-4 me-3"></i>
                        <div class="text-start">
                            <strong class="d-block text-white-50">نام:</strong>
                            <span class="fs-5 fw-bold text-info">@Model.Parent.ParentFirstName</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="bi bi-person-badge text-warning fs-4 me-3"></i>
                        <div class="text-start">
                            <strong class="d-block text-white-50">نام خانوادگی:</strong>
                            <span class="fs-5 fw-bold text-info">@Model.Parent.ParentLastName</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="bi bi-credit-card text-warning fs-4 me-3"></i>
                        <div class="text-start">
                            <strong class="d-block text-white-50">کد ملی:</strong>
                            <span class="fs-5 fw-bold text-info">@Model.Parent.ParentNationalCode</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center">
                <h5 class="mb-3">
                    <i class="bi bi-currency-dollar text-warning me-2"></i>جمع مبالغ پرداخت نشده:
                </h5>
                @if (Model.Parent.Children.All(x => x.HasPaid))
                {
                    <span class="badge bg-success px-4 py-3 fs-6">
                        <i class="bi bi-check-circle-fill me-2"></i>همه پرداخت‌ها انجام شده است
                    </span>
                }
                else
                {
                    var unpaidTotal = Model.Parent.Children.Where(x => x.Bills != null).Sum(x => x.Bills.Where(b => !b.HasPaid).Sum(b => b.TotalPrice - b.PaidPrice));
                    <span class="badge bg-danger px-4 py-3 fs-6">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>@unpaidTotal.ToString("N0") ریال
                    </span>
                }
            </div>
        </div>
    </div>

    <!-- 👶 Children List -->
    <div class="card shadow-lg border-info">
        <div class="card-header bg-info bg-gradient text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-people-fill fs-4 me-2"></i>لیست فرزندان
            </h4>
            <span class="badge bg-light text-dark fs-6">
                <i class="bi bi-person-check me-1"></i>@Model.Parent.Children.Count مورد
            </span>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover table-dark text-center align-middle rounded shadow-sm">
                <thead class="table-light text-dark">
                    <tr>
                        <th class="fw-bold"><i class="bi bi-hash me-1"></i>ردیف</th>
                        <th><i class="bi bi-person-circle me-1"></i>نام</th>
                        <th><i class="bi bi-credit-card me-1"></i>کد ملی</th>
                        <th><i class="bi bi-balloon me-1"></i>تولد</th>
                        <th><i class="bi bi-book me-1"></i>پایه</th>
                        <th><i class="bi bi-cash-coin me-1"></i>پرداخت</th>
                        <th><i class="bi bi-car-front me-1"></i>راننده</th>
                        <th><i class="bi bi-geo-alt me-1"></i>مسیر</th>
                        <th><i class="bi bi-receipt me-1"></i>قبض</th>
                        <th><i class="bi bi-trash me-1"></i>حذف</th>
                        <th><i class="bi bi-pencil me-1"></i>ویرایش</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var child in Model.Parent.Children.Select((c, i) => new { Index = i + 1, Child = c }))
                    {
                        var driver = Model.Drivers.FirstOrDefault(x => x.Id == child.Child.DriverId);
                        <tr>
                            <td class="fw-bold text-warning">@child.Index</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-person text-info me-2"></i>
                                    @child.Child.FirstName @child.Child.LastName
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-123 text-success me-2"></i>
                                    @child.Child.NationalCode
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="bi bi-calendar-event text-primary me-2"></i>
                                    @child.Child.BirthDate.ToPersain().ToString("yyyy/MM/dd")
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-bookmark me-1"></i>@child.Child.Class
                                </span>
                            </td>
                            <td>
                                @if (child.Child.HasPaid && child.Child.Bills.Count > 0)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>پرداخت شده
                                    </span>
                                }
                                else if (child.Child.Bills != null && child.Child.Bills.Count > 0)
                                {
                                    var unpaid = child.Child.Bills.Where(x => !x.HasPaid).Sum(x => x.TotalPrice - x.PaidPrice);
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle me-1"></i>@unpaid.ToString("N0") ریال
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-info-circle me-1"></i>قبضی صادر نشده
                                    </span>
                                }
                            </td>
                            <td>
                                @if (child.Child.DriverId == 0 || child.Child.DriverId == null || driver == null)
                                {
                                    <span class="text-muted">
                                        <i class="bi bi-person-x me-1"></i>اختصاص داده نشده
                                    </span>
                                }
                                else
                                {
                                    <span class="text-success">
                                        <i class="bi bi-person-check me-1"></i>@driver.Id - @driver.Name @driver.LastName
                                    </span>
                                }
                            </td>
                            <td>
                                @if (child.Child.Path != null)
                                {
                                    <button class="btn btn-sm btn-outline-primary view-route"
                                            data-pickup="@child.Child.Path.Location1.Address"
                                            data-destination="@child.Child.Path.Location2.Address"
                                            data-pickup-lat="@child.Child.Path.Location1.Latitude"
                                            data-pickup-lng="@child.Child.Path.Location1.Longitude"
                                            data-dest-lat="@child.Child.Path.Location2.Latitude"
                                            data-dest-lng="@child.Child.Path.Location2.Longitude">
                                        <i class="bi bi-map me-1"></i>مشاهده
                                    </button>
                                }
                            </td>
                            <td>
                                <form asp-action="CreateBill" method="post" class="d-inline">
                                    <input name="ChildId" type="hidden" value="@child.Child.Id" />
                                    <button class="btn btn-sm btn-outline-warning" type="submit"
                                            data-bs-toggle="tooltip" title="صدور قبض جدید">
                                        <i class="bi bi-file-earmark-plus me-1"></i>صدور
                                    </button>
                                </form>
                            </td>
                            <td>
                                <a asp-action="DeleteChild" asp-route-id="@child.Child.Id" asp-route-PId="@Model.Parent.Id"
                                   class="btn btn-sm btn-outline-danger rounded-pill shadow-sm"
                                   data-bs-toggle="tooltip" title="حذف فرزند"
                                   onclick="return confirm('آیا از حذف این فرزند مطمئن هستید؟')">
                                    <i class="bi bi-trash"></i> حذف
                                </a>
                            </td>
                            <td>
                                <a asp-action="UpdateChild" asp-route-id="@child.Child.Id" asp-route-parentId="@Model.Parent.Id"
                                   class="btn btn-sm btn-outline-info rounded-pill shadow-sm"
                                   data-bs-toggle="tooltip" title="ویرایش اطلاعات فرزند">
                                    <i class="bi bi-pencil-square"></i> ویرایش
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- 🔙 Back Button -->
    <div class="mt-4 text-center">
        <a asp-action="Index" asp-controller="Parents" class="btn btn-secondary px-4">
            <i class="bi bi-arrow-right-circle me-2"></i>بازگشت به لیست والدین
        </a>
    </div>
</div>

<!-- 🗺 Route Modal -->
<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-primary">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="bi bi-map text-primary me-2"></i>مسیر سرویس
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-geo-alt-fill text-success me-2"></i>
                            <div>
                                <strong class="d-block text-white-50">مبدا:</strong>
                                <span id="pickupLocation" class="text-success"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-geo-fill text-danger me-2"></i>
                            <div>
                                <strong class="d-block text-white-50">مقصد:</strong>
                                <span id="destinationLocation" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="routeMap"></div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>بستن
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 📜 Scripts -->
@section Scripts {
    <!-- Leaflet JS -->
    <script src="~/Leaflet/leaflet.js"></script>

    <script>
        $(function () {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Arak coordinates (center point)
            const arakCenter = [34.0918, 49.6892];
            let map = null;
            let pickupMarker = null, destMarker = null, routeLine = null;
            let pulseInterval = null;

            $('.view-route').click(function () {
                const pickupLat = parseFloat($(this).data('pickup-lat'));
                const pickupLng = parseFloat($(this).data('pickup-lng'));
                const destLat = parseFloat($(this).data('dest-lat'));
                const destLng = parseFloat($(this).data('dest-lng'));
                const pickupAddress = $(this).data('pickup');
                const destAddress = $(this).data('destination');

                $('#pickupLocation').text(pickupAddress);
                $('#destinationLocation').text(destAddress);

                // Initialize map if not created
                if (!map) {
                    map = L.map('routeMap', {
                        preferCanvas: true,
                        center: arakCenter,
                        zoom: 12
                    });

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                }

                // Clean up old markers/route
                if (pickupMarker) map.removeLayer(pickupMarker);
                if (destMarker) map.removeLayer(destMarker);
                if (routeLine) map.removeLayer(routeLine);
                clearPulseEffects();

                // Add pickup marker (green)
                pickupMarker = L.marker([pickupLat, pickupLng], {
                    icon: L.divIcon({
                        className: 'origin-marker',
                        html: '<div class="pulse-effect" style="background:#28a745;color:white;padding:4px 8px;border-radius:6px;border:2px solid white;"><i class="bi bi-house-fill me-1"></i>مبدا</div>',
                        iconSize: [40, 40]
                    })
                }).addTo(map);

                // Add destination marker (red)
                destMarker = L.marker([destLat, destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div class="pulse-effect" style="background:#dc3545;color:white;padding:4px 8px;border-radius:6px;border:2px solid white;"><i class="bi bi-building-fill me-1"></i>مقصد</div>',
                        iconSize: [40, 40]
                    })
                }).addTo(map);

                // Route polyline
                routeLine = L.polyline([[pickupLat, pickupLng], [destLat, destLng]], {
                    color: '#00BFFF',
                    weight: 4,
                    dashArray: '5,5',
                    opacity: 0.8
                }).addTo(map);

                // Auto zoom to fit
                map.fitBounds([[pickupLat, pickupLng], [destLat, destLng]], {
                    padding: [50, 50]
                });

                // Show modal
                $('#routeModal').modal('show');
            });

            function clearPulseEffects() {
                if (pulseInterval) {
                    clearInterval(pulseInterval);
                }
            }

            // Ensure map resizes properly when modal is shown
            $('#routeModal').on('shown.bs.modal', function () {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize({animate: false});
                    }, 100);
                }
            });

            // Clean up when modal is closed
            $('#routeModal').on('hidden.bs.modal', function () {
                clearPulseEffects();
            });

            // Add hover effects to table rows
            $('tbody tr').hover(
                function() {
                    $(this).addClass('bg-secondary bg-opacity-25');
                },
                function() {
                    $(this).removeClass('bg-secondary bg-opacity-25');
                }
            );
        });
    </script>
}