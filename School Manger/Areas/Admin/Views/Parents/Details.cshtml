<!-- 👨‍👩‍👧‍👦 Parent Details Page -->
@using School_Manger.Models.PageView
@using School_Manger.Extension
@model AdminParent

@{
    ViewData["Title"] = "📋 جزئیات والدین";
    Layout = "_AdminLayout";
}

<!-- Leaflet Stylesheet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    #routeMap {
        height: 400px;
        width: 100%;
        border-radius: 5px;
        margin-top: 15px;
    }

    .leaflet-container {
        font-family: inherit;
    }

    .badge {
        font-size: 1rem;
    }
</style>

<div class="container-fluid bg-dark text-white rounded shadow p-4" dir="rtl">
    <!-- 👨‍👩 Parent Info -->
    <div class="card mb-4 border-light shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i> اطلاعات والدین</h4>
        </div>
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4"><strong><i class="bi bi-person"></i> نام:</strong> @Model.Parent.ParentFirstName</div>
                <div class="col-md-4"><strong><i class="bi bi-person"></i> نام خانوادگی:</strong> @Model.Parent.ParentLastName</div>
                <div class="col-md-4"><strong><i class="bi bi-person-vcard"></i> کد ملی:</strong> @Model.Parent.ParentNationalCode</div>
            </div>

            <div class="mt-4">
                <h5><i class="bi bi-credit-card-fill"></i> جمع مبالغ پرداخت نشده:</h5>
                @if (Model.Parent.Children.All(x => x.HasPaid))
                {
                    <span class="badge bg-success px-3 py-2">✅ همه پرداخت‌ها انجام شده است</span>
                }
                else
                {
                    var unpaidTotal = Model.Parent.Children.Where(x=>x.Bills != null).Sum(x => x.Bills.Where(b => !b.HasPaid).Sum(b => b.TotalPrice - b.PaidPrice));
                    <span class="badge bg-danger px-3 py-2">💸 @unpaidTotal.ToString("N0") ریال</span>
                }
            </div>
        </div>
    </div>

    <!-- 👶 Children List -->
    <div class="card shadow border-info">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i> لیست فرزندان</h4>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover table-dark text-center align-middle rounded shadow-sm">
                <thead class="table-light text-dark">
                    <tr>
                        <th>ردیف</th>
                        <th><i class="bi bi-person"></i> نام</th>
                        <th><i class="bi bi-person-vcard"></i> کد ملی</th>
                        <th><i class="bi bi-cake2-fill"></i> تولد</th>
                        <th><i class="bi bi-building"></i> پایه</th>
                        <th><i class="bi bi-cash"></i> پرداخت</th>
                        <th><i class="bi bi-car-front-fill"></i> راننده</th>
                        <th>🗺 مسیر</th>
                        <th><i class="bi bi-receipt"></i> قبض</th>
                        <th><i class="bi bi-gear"></i> عملیات</th>
                        <th><i class="bi bi-pen"></i> ویرایش</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var child in Model.Parent.Children.Select((c, i) => new { Index = i + 1, Child = c }))
                    {
                        var driver = Model.Drivers.FirstOrDefault(x => x.Id == child.Child.DriverId);
                        <tr>
                            <td>@child.Index</td>
                            <td>@child.Child.FirstName @child.Child.LastName</td>
                            <td>@child.Child.NationalCode</td>
                            <td>@child.Child.BirthDate.ToPersain().ToString("yyyy/MM/dd")</td>
                            <td>@child.Child.Class</td>
                            <td>
                                @if (child.Child.HasPaid && child.Child.Bills.Count >0)
                                {
                                    <span class="badge bg-success">✅ پرداخت شده</span>
                                }
                                else if(child.Child.Bills != null && child.Child.Bills.Count >0)
                                {
                                    var unpaid = child.Child.Bills.Where(x => !x.HasPaid).Sum(x => x.TotalPrice - x.PaidPrice);
                                    <span class="badge bg-danger">💳 @unpaid.ToString("N0") ریال</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">✅ قبضی صادر نشده</span>
                                }
                            </td>
                            <td>
                                @if (child.Child.DriverId == 0 || child.Child.DriverId == null || driver == null)
                                {
                                    <span class="text-muted">❌ اختصاص داده نشده</span>
                                }
                                else
                                {
                                    <span><i class="bi bi-car-front-fill"></i> @driver.Id - @driver.Name @driver.LastName</span>
                                }
                            </td>
                            <td>
                                @if(child.Child.Path != null){
                                <button class="btn btn-sm btn-outline-primary view-route"
                                        data-pickup="@child.Child.Path.Location1.Address"
                                        data-destination="@child.Child.Path.Location2.Address"
                                        data-pickup-lat="@child.Child.Path.Location1.Latitude"
                                        data-pickup-lng="@child.Child.Path.Location1.Longitude"
                                        data-dest-lat="@child.Child.Path.Location2.Latitude"
                                        data-dest-lng="@child.Child.Path.Location2.Longitude">
                                    <i class="bi bi-map"></i> مشاهده
                                </button>
                                }
                            </td>
                            <td>
                                <form asp-action="CreateBill" method="post" class="d-inline">
                                    <input name="ChildId" type="hidden" value="@child.Child.Id" />
                                    <button class="btn btn-sm btn-outline-warning" type="submit">
                                        <i class="bi bi-file-earmark-text"></i> صدور
                                    </button>
                                </form>
                            </td>
                            <td>
                                <a asp-action="DeleteChild" asp-route-id="@child.Child.Id" asp-route-PId="@Model.Parent.Id"
                                   class="btn text-black bg-danger btn-sm btn-outline-light rounded-pill shadow-sm" title="حذف"
                                   onclick="return confirm('آیا از حذف این فرزند مطمئن هستید؟')">
                                    <i class="bi bi-trash"></i>  حذف
                                </a>
                            </td>
                            <td>
                                <a asp-action="UpdateChild" asp-route-id="@child.Child.Id" asp-route-parentId="@Model.Parent.Id"
                                   class="btn btn-sm btn-outline-info rounded-pill shadow-sm ms-2" title="ویرایش فرزند">
                                    <i class="bi bi-pencil-square"></i> ویرایش
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- 🔙 Back Button -->
    <div class="mt-4 text-center">
        <a asp-action="Index" asp-controller="Parents" class="btn btn-secondary">
            <i class="bi bi-arrow-right"></i> بازگشت به لیست والدین
        </a>
    </div>
</div>

<!-- 🗺 Route Modal -->
<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-map"></i> 🗺 مسیر سرویس</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6"><strong>📍 مبدا:</strong> <span id="pickupLocation"></span></div>
                    <div class="col-md-6"><strong>🏁 مقصد:</strong> <span id="destinationLocation"></span></div>
                </div>
                <div id="routeMap"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

<!-- 📜 Scripts -->
@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        $(function () {
            // Arak coordinates (center point)
            const arakCenter = [34.0918, 49.6892];
            let map = null;
            let pickupMarker = null, destMarker = null, routeLine = null;
            let positionInfoElement = null;
            let pulseInterval = null;

                    $('.view-route').click(function () {
            const pickupLat = parseFloat($(this).data('pickup-lat'));
            const pickupLng = parseFloat($(this).data('pickup-lng'));
            const destLat = parseFloat($(this).data('dest-lat'));
            const destLng = parseFloat($(this).data('dest-lng'));
            const pickupAddress = $(this).data('pickup');
            const destAddress = $(this).data('destination');

            $('#pickupLocation').text(pickupAddress);
            $('#destinationLocation').text(destAddress);

            // Initialize map if not created
            if (!map) {
                map = L.map('routeMap', {
                    preferCanvas: true,
                    center: arakCenter,
                    zoom: 12
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
            }

            // Clean up old markers/route
            if (pickupMarker) map.removeLayer(pickupMarker);
            if (destMarker) map.removeLayer(destMarker);
            if (routeLine) map.removeLayer(routeLine);
            clearPulseEffects();

            // Add pickup marker (green)
            pickupMarker = L.marker([pickupLat, pickupLng], {
                icon: L.divIcon({
                    className: 'origin-marker',
                    html: '<div style="background:green;color:white;padding:2px 5px;border-radius:4px;">📍 مبدا</div>',
                    iconSize: [30, 30]
                })
            }).addTo(map);

            // Add destination marker (red)
            destMarker = L.marker([destLat, destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background:red;color:white;padding:2px 5px;border-radius:4px;">🏁 مقصد</div>',
                    iconSize: [30, 30]
                })
            }).addTo(map);

            // Route polyline
            routeLine = L.polyline([[pickupLat, pickupLng], [destLat, destLng]], {
                color: '#00BFFF',
                weight: 4,
                dashArray: '5,5'
            }).addTo(map);

            // Add pulse effect
            addPulseEffect(pickupLat, pickupLng, 'origin-pulse');
            addPulseEffect(destLat, destLng, 'destination-pulse');

            // Auto zoom to fit
            map.fitBounds([[pickupLat, pickupLng], [destLat, destLng]], {
                padding: [50, 50]
            });

            // Show modal
            $('#routeModal').modal('show');
        });


            function addPulseEffect(lat, lng, className) {
                const pulse = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillOpacity: 0,
                    color: 'transparent',
                    className: className
                }).addTo(map);

                let size = 10;
                const maxSize = 30;
                const step = 2;

                pulseInterval = setInterval(() => {
                    size += step;
                    if (size > maxSize) {
                        size = 10;
                    }
                    pulse.setRadius(size);
                    pulse.setStyle({
                        fillOpacity: 1 - (size/maxSize)
                    });
                }, 100);
            }

            function clearPulseEffects() {
                if (pulseInterval) {
                    clearInterval(pulseInterval);
                }
                map.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker &&
                        (layer.options.className === 'origin-pulse' ||
                         layer.options.className === 'destination-pulse')) {
                        map.removeLayer(layer);
                    }
                });
            }

            function updatePositionInfo(text) {
                if (positionInfoElement) {
                    positionInfoElement.innerHTML = text;
                }
            }

            // Ensure map resizes properly when modal is shown
            $('#routeModal').on('shown.bs.modal', function () {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize({animate: false});
                        // Re-center on Arak if no route is selected
                        if (!pickupMarker && !destMarker) {
                            map.setView(arakCenter, 12);
                        }
                    }, 100);
                }
            });

            // Clean up when modal is closed
            $('#routeModal').on('hidden.bs.modal', function () {
                if (pickupMarker) pickupMarker.closePopup();
                if (destMarker) destMarker.closePopup();
                clearPulseEffects();
            });
        });
    </script>
}
