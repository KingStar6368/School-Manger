<!-- 👨‍👩‍👧‍👦 Parent Details Page -->
@using School_Manger.Models.PageView
@using School_Manger.Extension
@model AdminParent

@{
    ViewData["Title"] = "📋 جزئیات والدین";
    Layout = "_AdminLayout";
}

<!-- Leaflet Stylesheet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #routeMap {
        height: 400px;
        width: 100%;
        border-radius: 5px;
        margin-top: 15px;
    }

    .leaflet-container {
        font-family: inherit;
    }
</style>

<div class="container-fluid bg-dark text-white rounded p-3" dir="rtl">

    <!-- 🌟 Parent Info -->
    <div class="card mb-4 border-light shadow">
        <div class="card-header bg-primary text-white d-flex align-items-center">
            <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i> 👨‍👩‍👧 اطلاعات والدین</h4>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <p><strong>🧑‍🦱 نام:</strong> @Model.Parent.ParentFirstName</p>
                </div>
                <div class="col-md-4">
                    <p><strong>👩 نام خانوادگی:</strong> @Model.Parent.ParentLastName</p>
                </div>
                <div class="col-md-4">
                    <p><strong>🆔 کد ملی:</strong> @Model.Parent.ParentNationalCode</p>
                </div>
            </div>

            <div class="mt-4 text-center">
                <h5>💳 جمع مبالغ پرداخت نشده:</h5>
                @if (Model.Parent.Children.All(x => x.HasPaid))
                {
                    <span class="badge bg-success fs-6 py-2 px-3">
                        ✅ همه پرداخت‌ها انجام شده است
                    </span>
                }
                else
                {
                    var unpaidTotal = Model.Parent.Children.Sum(x => x.Bills.Where(b => !b.HasPaId).Sum(b => b.TotalPrice - b.PaidPrice));
                    <span class="badge bg-danger fs-6 py-2 px-3">
                        💸 @unpaidTotal.ToString("N0") تومان
                    </span>
                }
            </div>
        </div>
    </div>

    <!-- 👶 Children List -->
    <div class="card border-info shadow">
        <div class="card-header bg-info text-white d-flex align-items-center">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i> 👶 لیست فرزندان</h4>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-dark table-hover text-center align-middle rounded shadow-sm">
                <thead class="table-light text-dark">
                    <tr>
                        <th>ردیف</th>
                        <th>نام</th>
                        <th>کد ملی</th>
                        <th>🎂 تاریخ تولد</th>
                        <th>🏫 پایه</th>
                        <th>💰 پرداخت</th>
                        <th>🧑‍✈️ راننده</th>
                        <th>🗺 مسیر</th>
                        <th>🧾 قبض</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var child in Model.Parent.Children.Select((c, i) => new { Index = i + 1, Child = c }))
                    {
                        var driver = Model.Drivers.FirstOrDefault(x => x.Id == child.Child.DriverId);
                        <tr>
                            <td>@child.Index</td>
                            <td>@child.Child.FirstName @child.Child.LastName</td>
                            <td>@child.Child.NationalCode</td>
                            <td>@child.Child.BirthDate.ToShortDateString()</td>
                            <td>@child.Child.Class</td>
                            <td>
                                @if (child.Child.HasPaid)
                                {
                                    <span class="badge bg-success">✅ پرداخت شده</span>
                                }
                                else
                                {
                                    var unpaid = child.Child.Bills.Where(x => !x.HasPaId).Sum(x => x.TotalPrice - x.PaidPrice);
                                    <span class="badge bg-danger">💳 @unpaid.ToString("N0") تومان</span>
                                }
                            </td>
                            <td>
                                @if (child.Child.DriverId == 0 || driver == null)
                                {
                                    <span class="text-muted">❌ اختصاص داده نشده</span>
                                }
                                else
                                {
                                    <span>🧑‍✈️ @driver.Id - @driver.Name @driver.LastName</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-route"
                                        data-pickup="@child.Child.Path.Location1.Address"
                                        data-destination="@child.Child.Path.Location2.Address"
                                        data-pickup-lat="@child.Child.Path.Location1.Latitude"
                                        data-pickup-lng="@child.Child.Path.Location1.Longitude"
                                        data-dest-lat="@child.Child.Path.Location2.Latitude"
                                        data-dest-lng="@child.Child.Path.Location2.Longitude">
                                    <i class="bi bi-map"></i> مشاهده
                                </button>
                            </td>
                            <td>
                                <form asp-action="CreateBill" method="post" class="m-0">
                                    <input name="Child" type="hidden" value="@child.Child.EnCript()" />
                                    <button class="btn btn-sm btn-outline-warning" type="submit">
                                        <i class="bi bi-file-earmark-text"></i> صدور
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- 🔙 Back -->
    <div class="mt-4 text-center">
        <a asp-action="Index" asp-controller="Parents" class="btn btn-secondary">
            <i class="bi bi-arrow-right"></i> 🔙 بازگشت به لیست والدین
        </a>
    </div>
</div>

<!-- 🗺 Route Modal -->
<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-map"></i> 🗺 مسیر سرویس</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6"><strong>📍 محل سوار شدن:</strong> <span id="pickupLocation"></span></div>
                    <div class="col-md-6"><strong>🏁 مقصد:</strong> <span id="destinationLocation"></span></div>
                </div>
                <div id="routeMap"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

<!-- 📜 Scripts -->
@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        $(function () {
            let map, pickupMarker, destinationMarker;

            $('.view-route').click(function () {
                const pickupLat = parseFloat($(this).data('pickup-lat'));
                const pickupLng = parseFloat($(this).data('pickup-lng'));
                const destLat = parseFloat($(this).data('dest-lat'));
                const destLng = parseFloat($(this).data('dest-lng'));

                $('#pickupLocation').text($(this).data('pickup'));
                $('#destinationLocation').text($(this).data('destination'));

                if (!map) {
                    map = L.map('routeMap').setView([pickupLat, pickupLng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                }

                if (pickupMarker) map.removeLayer(pickupMarker);
                if (destinationMarker) map.removeLayer(destinationMarker);

                pickupMarker = L.marker([pickupLat, pickupLng]).addTo(map).bindPopup("📍 محل سوار شدن");
                destinationMarker = L.marker([destLat, destLng]).addTo(map).bindPopup("🏁 مقصد");

                L.polyline([[pickupLat, pickupLng], [destLat, destLng]], {
                    color: 'blue',
                    dashArray: '5, 5'
                }).addTo(map);

                map.fitBounds([[pickupLat, pickupLng], [destLat, destLng]], { padding: [30, 30] });
                $('#routeModal').modal('show');
            });

            $('#routeModal').on('hidden.bs.modal', function () {
                if (map) {
                    map.remove();
                    map = null;
                }
            });
        });
    </script>
}
