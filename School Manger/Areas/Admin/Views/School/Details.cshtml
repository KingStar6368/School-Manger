@using School_Manager.Core.Services.Interfaces
@using School_Manger.Models.PageView
@model AdminSchool
@inject IShiftService ShiftService;
@inject ISchoolService SchoolService;
@{
    ViewData["Title"] = "📚 اطلاعات مدرسه";
    Layout = "_AdminLayout";
}

<!-- School Info -->
<div class="card bg-dark text-white shadow-lg rounded-4 mb-4 border-primary border-2">
    <div class="card-header bg-primary bg-gradient rounded-top">
        <h4 class="mb-0 fw-bold"><i class="bi bi-building"></i> اطلاعات مدرسه</h4>
    </div>
    <div class="card-body row">
        <div class="col-md-6 mb-3">
            <strong>🏷️ نام مدرسه:</strong>
            <div class="ms-2">@Model.School.Name</div>
        </div>
        <div class="col-md-6 mb-3">
            <strong>👨‍<i class="bi bi-building"></i> نام مدیر:</strong>
            <div class="ms-2">@Model.School.ManagerName</div>
        </div>
        <div class="col-md-6 mb-3">
            <strong>⭐ امتیاز:</strong>
            <div>
                @for (int i = 1; i <= 5; i++)
                {
                    <i class="bi bi-star@(i <= Model.School.Rate ? "-fill" : "") text-warning fs-5"></i>
                }
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <strong>📍 آدرس:</strong>
            <div class="ms-2">@Model.School.Address.Address</div>
        </div>
        <div class="col-md-6">
            <strong>🗺️ موقعیت مکانی:</strong>
            <div id="schoolMap" style="height: 300px; width: 100%;" class="rounded shadow-sm border border-light mt-2"></div>
        </div>
        <div class="col-md-4">
            <form asp-area="Admin" asp-controller="AssignD2S" asp-action="ShiftIndex">
                <strong>شیفت های مدرسه :</strong>
                @{
                    var Shifts = await SchoolService.GetSchoolShifts(Model.School.Id);
                }
                <select id="ShiftOption" class="form-control">
                    @if (Shifts.Count > 0)
                    {
                        @foreach (var shift in Shifts)
                        {
                            <option value="@shift.Id">
                                @shift.Name : نام شیفت
                                @shift.Start : زمان شروع
                                @shift.End : زمان پایان
                            </option>
                        }
                    }
                    else
                    {
                        <option>
                            این مدرسه شیفت ندارد
                        </option>
                    }
                </select>
                @if (Shifts.Count > 0)
                {
                    <input name="ShiftId" id="ShiftId" value="@Shifts.FirstOrDefault().Id" type="hidden" />
                    <button class="mt-4 form-control bg-success text-white" type="submit">اختصاص دادن رانندگان این شیفت به دانش آموزان</button>
                }
            </form>
        </div>
        <div class="mt-4">
            <a asp-action="DeleteSchool" asp-route-id="@Model.School.Id"
               class="btn text-black bg-danger btn-sm btn-outline-light rounded-pill shadow-sm" title="حذف"
               onclick="return confirm('آیا از حذف این مدرسه مطمئن هستید؟')">
                <i class="bi bi-trash"></i> ️ حذف
            </a>
        </div>
        <div class="mt-4">
            <a asp-action="Index" class="btn btn-outline-light rounded-4">
                <i class="bi bi-arrow-right"></i> بازگشت به لیست
            </a>
        </div>

    </div>
</div>

<!-- Drivers -->
<div class="card bg-dark text-white shadow rounded-4 mb-4 border-secondary border-2">
    <div class="card-header bg-secondary bg-gradient rounded-top">
        <h5 class="mb-0 fw-semibold"><i class="bi bi-car-front-fill"></i> رانندگان</h5>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-dark table-hover align-middle text-center">
            <thead class="table-light text-dark">
                <tr>
                    <th><i class="bi bi-person"></i> نام</th>
                    <th>👥 نام خانوادگی</th>
                    <th><i class="bi bi-person-vcard"></i> کد ملی</th>
                    <th>💺 تعداد صندلی خودرو</th>
                    <th>🚗 خودرو</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var driver in Model.Drivers)
                {
                    <tr>
                        <td>@driver.Name</td>
                        <td>@driver.LastName</td>
                        <td>@driver.NationCode</td>
                        <td>@driver.Car.SeatNumber</td>
                        <td>@driver.Car.Name</td>
                        <td>
                            <form asp-controller="Driver" asp-action="Details">
                                <input type="hidden" name="id" value="@driver.Id" />
                                <button class="btn btn-sm btn-outline-info" type="submit">
                                    <i class="bi bi-file-earmark-text"></i> نمایش راننده
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Students -->
<div class="card bg-dark text-white shadow rounded-4 mb-4 border-success border-2">
    <div class="card-header bg-success bg-gradient rounded-top">
        <h5 class="mb-0 fw-semibold">🎓 دانش‌آموزان</h5>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-dark table-hover align-middle text-center">
            <thead class="table-light text-dark">
                <tr>
                    <th>👶 نام</th>
                    <th>👨‍👧 نام خانوادگی</th>
                    <th><i class="bi bi-person-vcard"></i> کد ملی</th>
                    <th>🏷️ کلاس</th>
                    <th><i class="bi bi-cash"></i> پرداخت</th>
                    <th>شیفت</th>
                    <th>نمایش</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in Model.Students)
                {
                    <tr>
                        <td>@student.FirstName</td>
                        <td>@student.LastName</td>
                        <td>@student.NationalCode</td>
                        <td>@student.Class</td>
                        <td>
                            @if (student.HasPaid)
                            {
                                <span class="badge bg-success">✅ پرداخت شده</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">❌ پرداخت نشده</span>
                            }
                        </td>
                        <td>@(ShiftService.GetShiftById(student.ShiftId) != null ? ShiftService.GetShiftById(student.ShiftId).Name : "شیفت انتخاب نشده")</td>
                        <td>
                            <form asp-controller="Parents" asp-action="CreateBill" method="post" class="d-inline">
                                <input name="ChildId" type="hidden" value="@student.Id" />
                                <button class="btn btn-sm btn-outline-warning" type="submit">
                                    <i class="bi bi-file-earmark-text"></i> صدور
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Get the coordinates from the Razor model
        var lat = @Model.School.Address.Latitude;
        var lng = @Model.School.Address.Longitude;

        // Initialize the map
        var map = L.map('schoolMap').setView([lat, lng], 15);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add a marker at the school location with a popup
        L.marker([lat, lng]).addTo(map)
            .bindPopup('📍 موقعیت مدرسه')
            .openPopup();
                // Update hidden shift field when shift selection changes
        document.getElementById('ShiftOption').addEventListener('change', function() {
            document.getElementById('ShiftId').value =  document.getElementById('ShiftOption').value;
        });
    </script>
}

