@using School_Manager.Core.Services.Interfaces
@using School_Manger.Extension
@model List<School_Manager.Core.ViewModels.FModels.BillDto>
@inject IBillService BillService
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "🔎 جستجو پیشرفته قبض‌ها";

    // محاسبات آماری
    long totalBills = Model.Count;
    long paidBills = Model.Count(x => x.HasPaid);
    long unpaidBills = Model.Count(x => !x.HasPaid);
    long totalAmount = Model.Sum(x => x.TotalPrice);
    long paidAmount = Model.Sum(x => x.PaidPrice);
    long remainingAmount = totalAmount - paidAmount;
}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white shadow-sm border-0">
            <div class="card-body text-center">
                <i class="bi bi-receipt fs-1 d-block mb-2"></i>
                <h4 class="mb-1">@totalBills</h4>
                <p class="mb-0">تعداد قبض‌ها</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white shadow-sm border-0">
            <div class="card-body text-center">
                <i class="bi bi-check-circle fs-1 d-block mb-2"></i>
                <h4 class="mb-1">@paidBills</h4>
                <p class="mb-0">پرداخت شده</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark shadow-sm border-0">
            <div class="card-body text-center">
                <i class="bi bi-clock-history fs-1 d-block mb-2"></i>
                <h4 class="mb-1">@unpaidBills</h4>
                <p class="mb-0">پرداخت نشده</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white shadow-sm border-0">
            <div class="card-body text-center">
                <i class="bi bi-cash-coin fs-1 d-block mb-2"></i>
                <h4 class="mb-1">@remainingAmount.ToString("N0") تومان</h4>
                <p class="mb-0">مانده قابل وصول</p>
            </div>
        </div>
    </div>
</div>

<div class="card bg-dark text-white shadow-lg rounded-4 border-primary border-2">
    <div class="card-header bg-primary bg-gradient d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold">
            <i class="bi bi-search me-2"></i> جستجو پیشرفته
        </h4>
    </div>
    <div class="card-body">
        <div class="container">
            @* جستجو راننده *@
            <form method="post" id="DriverPnl" asp-action="Driver" style="visibility:visible;display:none">
                <div class="row mb-4">
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام</label>
                        <input name="FirstName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام خانوادگی</label>
                        <input name="LastName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-credit-card me-1"></i> کدملی</label>
                        <input name="NationalCode" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-phone me-1"></i> موبایل</label>
                        <input name="Mobile" type="text" class="form-control price-separator" />
                    </div>
                </div>
                <div class="row justify-content-center container">
                    <button type="submit" class="col-4 btn btn-warning fw-bold">
                        <i class="bi bi-search me-2"></i> جستجو
                    </button>
                </div>
            </form>

            @* جستجو خانواده *@
            <form method="post" id="ParentPnl" asp-action="Parent" style="visibility:visible;display:none">
                <div class="row mb-4">
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام</label>
                        <input name="FirstName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام خانوادگی</label>
                        <input name="LastName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-credit-card me-1"></i> کدملی</label>
                        <input name="NationalCode" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-phone me-1"></i> موبایل</label>
                        <input name="Mobile" type="text" class="form-control price-separator" />
                    </div>
                </div>
                <div class="row justify-content-center container">
                    <button type="submit" class="col-4 btn btn-warning fw-bold">
                        <i class="bi bi-search me-2"></i> جستجو
                    </button>
                </div>
            </form>

            @* جستجو دانش آموزان *@
            <form method="post" id="ChildPnl" asp-action="Child" style="visibility:visible;display:none">
                <div class="row mb-4">
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام</label>
                        <input name="FirstName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-person me-1"></i> نام خانوادگی</label>
                        <input name="LastName" type="text" class="form-control price-separator" />
                    </div>
                    <div class="col-sm">
                        <label class="form-label fw-bold"><i class="bi bi-credit-card me-1"></i> کدملی</label>
                        <input name="NationalCode" type="text" class="form-control price-separator" />
                    </div>
                </div>
                <div class="row justify-content-center container">
                    <button type="submit" class="col-4 btn btn-warning fw-bold">
                        <i class="bi bi-search me-2"></i> جستجو
                    </button>
                </div>
            </form>

            @* جستجو قبض ها *@
            <form method="post" id="BillPnl" asp-action="BilPays" style="visibility:visible;display:inline">
                <div class="row mb-4">
                    <div class="col-sm-6">
                        <label class="form-label fw-bold"><i class="bi bi-calendar me-1"></i> تاریخ شروع</label>
                        <input name="StartDate" type="date" class="form-control" />
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label fw-bold"><i class="bi bi-calendar me-1"></i> تاریخ پایان</label>
                        <input name="EndDate" type="date" class="form-control" />
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-4">
                        <label class="form-label fw-bold"><i class="bi bi-credit-card me-1"></i> وضعیت پرداخت</label>
                        <select name="HasPaid" class="form-select">
                            <option value="">همه</option>
                            <option value="true">پرداخت شده</option>
                            <option value="false">پرداخت نشده</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label fw-bold"><i class="bi bi-calendar-month me-1"></i> ماه</label>
                        <select name="MonthInt" class="form-select">
                            <option value="">انتخاب ماه</option>
                            <option value="1">فروردین</option>
                            <option value="2">اردیبهشت</option>
                            <option value="3">خرداد</option>
                            <option value="4">تیر</option>
                            <option value="5">مرداد</option>
                            <option value="6">شهریور</option>
                            <option value="7">مهر</option>
                            <option value="8">آبان</option>
                            <option value="9">آذر</option>
                            <option value="10">دی</option>
                            <option value="11">بهمن</option>
                            <option value="12">اسفند</option>
                        </select>
                    </div>
                </div>
                <div class="row justify-content-center container">
                    <button type="submit" class="col-4 btn btn-warning fw-bold">
                        <i class="bi bi-search me-2"></i> جستجوی قبض‌ها
                    </button>
                </div>
            </form>
        </div>

        <div class="container row col-md-4 mt-4">
            <div class="input-group">
                <span class="input-group-text bg-primary text-white">
                    <i class="bi bi-funnel"></i>
                </span>
                <select class="form-select rounded-start" id="PDropBox">
                    <option value="Child"><i class="bi bi-person"></i> دانش آموزان</option>
                    <option value="Parent"><i class="bi bi-people"></i> خانواده</option>
                    <option value="Driver"><i class="bi bi-steering-wheel"></i> راننده</option>
                    <option value="Bill" selected><i class="bi bi-receipt"></i> قبض‌ها</option>
                </select>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="row mt-4 mb-3">
            <div class="col-md-4 mb-2">
                <div class="input-group">
                    <span class="input-group-text bg-info text-white">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="globalSearch" placeholder="جستجوی کلی در قبض‌ها...">
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <select class="form-select" id="statusFilter">
                    <option value="">فیلتر وضعیت</option>
                    <option value="paid">پرداخت شده</option>
                    <option value="unpaid">پرداخت نشده</option>
                    <option value="expired">منقضی شده</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <select class="form-select" id="typeFilter">
                    <option value="">فیلتر نوع قبض</option>
                    <option value="normal">عادی</option>
                    <option value="special">خاص</option>
                </select>
            </div>
            <div class="col-md-2 mb-2 d-flex gap-2">
                <button class="btn btn-outline-warning flex-fill" id="resetFilters">
                    <i class="bi bi-arrow-clockwise me-1"></i>بازنشانی
                </button>
            </div>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-dark table-hover table-bordered align-middle text-center rounded-3 overflow-hidden" id="billsTable">
                <thead class="table-light text-dark">
                    <tr>
                        <th><i class="bi bi-hash me-1"></i> ردیف</th>
                        <th><i class="bi bi-receipt me-1"></i> عنوان قبض</th>
                        <th><i class="bi bi-receipt me-1"></i> نام و نام خانوادگی</th>
                        <th><i class="bi bi-file-text me-1"></i> نوع قبض</th>
                        <th><i class="bi bi-cash-stack me-1"></i> مبلغ کل</th>
                        <th><i class="bi bi-cash-coin me-1"></i> پرداخت شده</th>
                        <th><i class="bi bi-clock me-1"></i> مانده</th>
                        <th><i class="bi bi-info-circle me-1"></i> وضعیت</th>
                        <th><i class="bi bi-calendar-x me-1"></i> تاریخ انقضا</th>
                        <th><i class="bi bi-calendar-check me-1"></i> تاریخ پرداخت</th>
                        <th><i class="bi bi-gear me-1"></i> عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        @try
                        {

                            var bill = Model[i];
                            var remaining = bill.TotalPrice - bill.PaidPrice;
                            var isExpired = DateTime.Now > bill.BillExpiredTime;
                            var statusClass = bill.HasPaid ? "success" : (isExpired ? "danger" : "warning");
                            var statusText = (bill.HasPaid ? "پرداخت شده" : (isExpired ? "منقضی شده" : "در انتظار پرداخت"));

                            <tr data-status="@(bill.HasPaid ? "paid" : "unpaid")"
                                data-type="@bill.TypeOfBill?.ToLower()"
                                data-expired="@isExpired.ToString().ToLower()">
                                <td>@(i + 1)</td>
                                <td>@bill.Name</td>
                                <td>@BillService.GetFullNameByBillId(bill.Id)</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-tag me-1"></i>@bill.TypeOfBill
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        <i class="bi bi-currency-dollar me-1"></i>@bill.TotalPrice.ToString("N0") تومان
                                    </span>
                                </td>
                                <td>
                                    @if (bill.PaidPrice > 0)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>@bill.PaidPrice.ToString("N0") تومان
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>پرداخت نشده
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (remaining > 0)
                                    {
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock-history me-1"></i>@remaining.ToString("N0") تومان
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>صفر
                                        </span>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-@statusClass">
                                        <i class="bi bi-@(bill.HasPaid ? "check-circle" : isExpired ? "exclamation-triangle" : "clock") me-1"></i>
                                        @statusText
                                    </span>
                                </td>
                                <td>
                                    @if (isExpired)
                                    {
                                        <span class="badge bg-danger">
                                            <i class="bi bi-calendar-x me-1"></i>@bill.BillExpiredTimePer
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-white">
                                            <i class="bi bi-calendar me-1"></i>@bill.BillExpiredTimePer
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (bill.HasPaid && bill.PaidTime.HasValue)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-calendar-check me-1"></i>@bill.PaidTime.Value.ToPersianString()
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-dash-circle me-1"></i>---
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                        @if (!bill.HasPaid && !isExpired)
                                        {
                                            <button class="btn btn-sm btn-outline-success" onclick="payBill(@bill.Id)" title="ثبت پرداخت">
                                                <i class="bi bi-credit-card"></i>
                                            </button>
                                        }
                                        <button class="btn btn-sm btn-outline-info" onclick="showBillDetails(@bill.Id)" title="جزئیات قبض">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="printBill(@bill.Id)" title="چاپ قبض">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <a href="@Url.Action("Edit", "Bill", new { id = bill.Id })" class="btn btn-sm btn-outline-primary" title="ویرایش">
                                            <i class="bi bi-pencil"></i>
                                        </a>

                                    </div>
                                </td>
                            </tr>
                        }
                        catch (Exception ex)
                        {
                            <tr>
                                @ex.Message
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Results Counter -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <span id="resultsCount">نمایش @Model.Count مورد از @Model.Count نتیجه</span>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary">مجموع مبلغ: @totalAmount.ToString("N0") تومان</span>
                        <span class="badge bg-success">پرداخت شده: @paidAmount.ToString("N0") تومان</span>
                        <span class="badge bg-warning">مانده: @remainingAmount.ToString("N0") تومان</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Panel switcher
        const ParentPnl = document.getElementById('ParentPnl');
        const ChildPnl = document.getElementById('ChildPnl');
        const DriverPnl = document.getElementById('DriverPnl');
        const BillPnl = document.getElementById('BillPnl');

        document.getElementById('PDropBox').addEventListener('change', function() {
            const Selectedvalue = this.value;

            // Hide all panels
            ParentPnl.style.display = "none";
            ChildPnl.style.display = "none";
            DriverPnl.style.display = "none";
            BillPnl.style.display = "none";

            // Show selected panel
            if(Selectedvalue == "Driver"){
                DriverPnl.style.display = "inline";
            }
            else if(Selectedvalue == "Parent"){
                ParentPnl.style.display = "inline";
            }
            else if(Selectedvalue == "Child"){
                ChildPnl.style.display = "inline";
            }
            else if(Selectedvalue == "Bill"){
                BillPnl.style.display = "inline";
            }
        });

        // Filter functionality for bills
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('billsTable');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const globalSearch = document.getElementById('globalSearch');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const resetBtn = document.getElementById('resetFilters');
            const resultsCount = document.getElementById('resultsCount');

            function filterRows() {
                const globalSearchTerm = globalSearch.value.toLowerCase();
                const statusValue = statusFilter.value;
                const typeValue = typeFilter.value;

                let visibleCount = 0;
                let totalAmount = 0;
                let paidAmount = 0;

                rows.forEach(row => {
                    let showRow = true;

                    // Global search
                    if (globalSearchTerm) {
                        const rowText = row.textContent.toLowerCase();
                        if (!rowText.includes(globalSearchTerm)) {
                            showRow = false;
                        }
                    }

                    // Status filter
                    if (statusValue) {
                        if (statusValue === 'paid' && row.dataset.status !== 'paid') {
                            showRow = false;
                        }
                        if (statusValue === 'unpaid' && row.dataset.status !== 'unpaid') {
                            showRow = false;
                        }
                        if (statusValue === 'expired' && row.dataset.expired !== 'true') {
                            showRow = false;
                        }
                    }

                    // Type filter
                    if (typeValue && row.dataset.type !== typeValue) {
                        showRow = false;
                    }

                    if (showRow) {
                        row.style.display = '';
                        visibleCount++;

                        // Calculate amounts from visible rows
                        const cells = row.querySelectorAll('td');
                        const totalPrice = parseInt(cells[3].querySelector('.badge').textContent.replace(/[^0-9]/g, ''));
                        const paidPrice = cells[4].querySelector('.badge') ?
                            parseInt(cells[4].querySelector('.badge').textContent.replace(/[^0-9]/g, '')) || 0 : 0;

                        totalAmount += totalPrice;
                        paidAmount += paidPrice;
                    } else {
                        row.style.display = 'none';
                    }
                });

                updateResultsCount(visibleCount, totalAmount, paidAmount);
            }

            function updateResultsCount(visibleCount, totalAmount, paidAmount) {
                const remainingAmount = totalAmount - paidAmount;
                resultsCount.innerHTML = `
                    <span>نمایش ${visibleCount} مورد از ${rows.length} نتیجه</span>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary">مجموع: ${totalAmount.toLocaleString()} تومان</span>
                        <span class="badge bg-success">پرداخت: ${paidAmount.toLocaleString()} تومان</span>
                        <span class="badge bg-warning">مانده: ${remainingAmount.toLocaleString()} تومان</span>
                    </div>
                `;
            }

            function resetFilters() {
                globalSearch.value = '';
                statusFilter.value = '';
                typeFilter.value = '';

                rows.forEach(row => {
                    row.style.display = '';
                });

                // Recalculate totals from all rows
                let totalAmount = 0;
                let paidAmount = 0;

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const totalPrice = parseInt(cells[3].querySelector('.badge').textContent.replace(/[^0-9]/g, ''));
                    const paidPrice = cells[4].querySelector('.badge') ?
                        parseInt(cells[4].querySelector('.badge').textContent.replace(/[^0-9]/g, '')) || 0 : 0;

                    totalAmount += totalPrice;
                    paidAmount += paidPrice;
                });

                updateResultsCount(rows.length, totalAmount, paidAmount);
            }

            // Initialize totals calculation
            function initializeTotals() {
                let totalAmount = 0;
                let paidAmount = 0;

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const totalPrice = parseInt(cells[3].querySelector('.badge').textContent.replace(/[^0-9]/g, ''));
                    const paidPrice = cells[4].querySelector('.badge') ?
                        parseInt(cells[4].querySelector('.badge').textContent.replace(/[^0-9]/g, '')) || 0 : 0;

                    totalAmount += totalPrice;
                    paidAmount += paidPrice;
                });

                updateResultsCount(rows.length, totalAmount, paidAmount);
            }

            // Event listeners
            globalSearch.addEventListener('input', filterRows);
            statusFilter.addEventListener('change', filterRows);
            typeFilter.addEventListener('change', filterRows);
            resetBtn.addEventListener('click', resetFilters);

            // Initialize
            initializeTotals();
        });

        // Bill operations functions
        function payBill(billId) {
            if (confirm('آیا از ثبت پرداخت این قبض اطمینان دارید؟')) {
                // Implement payment logic here
                fetch(`/Admin/Bill/Pay/${billId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'خطا در ثبت پرداخت');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('خطا در ارتباط با سرور');
                });
            }
        }

        function showBillDetails(billId) {
            window.open(`/Admin/Bill/Details/${billId}`, '_blank');
        }

        function printBill(billId) {
            window.open(`/Admin/Bill/Print/${billId}`, '_blank');
        }
    </script>

    <style>
        .table-active {
            background-color: rgba(13, 110, 253, 0.2) !important;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }

        #globalSearch {
            direction: rtl;
        }

        .badge {
            font-size: 0.85em;
        }

        /* Responsive table */
        @@media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85em;
            }

            .badge {
                font-size: 0.75em;
            }
        }
    </style>
}