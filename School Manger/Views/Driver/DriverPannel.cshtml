@model School_Manger.Models.PageView.DriverDashbord

@{
    ViewData["Title"] = "پنل راننده";
    Layout = "_Layout";
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container-fluid bg-dark text-white py-4" dir="rtl">
    <!-- Header Section -->
    <div class="row bg-black text-center rounded-4 shadow-sm py-4 mb-4 border-primary border-2">
        <h3 class="fw-bold mb-3">
            <i class="bi bi-steering-wheel me-2"></i> اطلاعات راننده
        </h3>
        <div class="d-flex justify-content-center flex-wrap gap-4 mt-3">
            <div class="text-center">
                <div class="text-primary mb-1">
                    <i class="bi bi-person fs-5"></i>
                </div>
                <span class="fw-semibold">نام:</span>
                <span class="fs-5 fw-bold text-warning">@Model.Driver.Name</span>
            </div>
            <div class="text-center">
                <div class="text-primary mb-1">
                    <i class="bi bi-person fs-5"></i>
                </div>
                <span class="fw-semibold">نام خانوادگی:</span>
                <span class="fs-5 fw-bold text-warning">@Model.Driver.LastName</span>
            </div>
            <div class="text-center">
                <div class="text-primary mb-1">
                    <i class="bi bi-car-front fs-5"></i>
                </div>
                <span class="fw-semibold">خودرو:</span>
                <span class="fs-5 fw-bold text-warning">@Model.Driver.Car.Name</span>
                <span class="badge bg-info ms-1">@Model.Driver.Car.PlateNumber</span>
            </div>
            <div class="text-center">
                <div class="text-primary mb-1">
                    <i class="bi bi-person-seat fs-5"></i>
                </div>
                <span class="fw-semibold">صندلی‌های خالی:</span>
                <span class="fs-5 fw-bold text-success">@Model.Driver.AvailableSeats</span>
            </div>
        </div>
    </div>

    <!-- Passenger List Section -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-white shadow-lg rounded-4 border-primary border-2">
                <div class="card-header bg-primary bg-gradient d-flex justify-content-between align-items-center py-3">
                    <h4 class="mb-0 fw-bold">
                        <i class="bi bi-people-fill me-2"></i> لیست مسافران
                    </h4>
                    <span class="badge bg-light text-primary fs-6">
                        <i class="bi bi-person-check me-1"></i> @Model.Passanger.Count مسافر
                    </span>
                </div>
                <div class="card-body">
                    @if (Model.Passanger != null && Model.Passanger.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-dark table-bordered table-hover align-middle text-center rounded-3 overflow-hidden">
                                <thead class="table-light text-dark">
                                    <tr>
                                        <th><i class="bi bi-hash me-1"></i> ردیف</th>
                                        <th><i class="bi bi-person me-1"></i> نام مسافر</th>
                                        <th><i class="bi bi-geo-alt me-1"></i> مبدا</th>
                                        <th><i class="bi bi-geo-alt-fill me-1"></i> مقصد</th>
                                        <th><i class="bi bi-clock me-1"></i> زمان رفت</th>
                                        <th><i class="bi bi-clock-history me-1"></i> زمان بازگشت</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var child in Model.Passanger)
                                    {
                                        <tr>
                                            <td>
                                                <span class="badge bg-secondary">@(Model.Passanger.IndexOf(child) + 1)</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">
                                                    <i class="bi bi-person-badge me-1"></i>@child.FirstName @child.LastName
                                                </span>
                                            </td>
                                            <td>
                                                <span class="text-info">
                                                    <i class="bi bi-pin-map me-1"></i>@child.Path.Location1.Address
                                                </span>
                                            </td>
                                            <td>
                                                <span class="text-warning">
                                                    <i class="bi bi-pin-map-fill me-1"></i>@child.Path.Location2.Address
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-clock me-1"></i>@child.Path.PickTime1
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    <i class="bi bi-clock-history me-1"></i>@child.Path.PickTime2
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center fw-bold my-4">
                            <i class="bi bi-exclamation-triangle me-2"></i> مسافری یافت نشد!
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark text-white shadow-lg rounded-4 border-success border-2">
                <div class="card-header bg-success bg-gradient d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-map me-2"></i> مسیرهای راننده
                    </h5>
                    <span class="badge bg-light text-success fs-6">
                        <i class="bi bi-geo me-1"></i> نقشه مسیرها
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="driverMap" style="height: 500px; width: 100%; border-radius: 0 0 12px 12px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const arakCenter = [34.0918, 49.6892]; // Default center if none present
            const map = L.map('driverMap').setView(arakCenter, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const passengers = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    Model.Passanger.Select(c => new
                    {
                            Name = $"{c.FirstName} {c.LastName}",
                            Pickup = new { Lat = c.Path.Location1.Latitude, Lng = c.Path.Location1.Longitude, Addr = c.Path.Location1.Address },
                            Dest = new { Lat = c.Path.Location2.Latitude, Lng = c.Path.Location2.Longitude, Addr = c.Path.Location2.Address }
                    })
            ));

        // Create custom icons
        const pickupIcon = L.divIcon({
            className: 'custom-pickup-icon',
            html: '<i class="bi bi-geo-alt-fill text-success fs-4"></i>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });

            const destinationIcon = L.divIcon({
                className: 'custom-dest-icon',
                html: '<i class="bi bi-geo-alt-fill text-danger fs-4"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            passengers.forEach((p, index) => {
                const pickupLatLng = [p.Pickup.Lat, p.Pickup.Lng];
                const destLatLng = [p.Dest.Lat, p.Dest.Lng];

                // Pickup marker
                L.marker(pickupLatLng, { icon: pickupIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <i class="bi bi-geo-alt text-success fs-5"></i>
                            <h6 class="fw-bold mt-1">مبدا مسافر ${index + 1}</h6>
                            <p class="mb-1"><strong>نام:</strong> ${p.Name}</p>
                            <p class="mb-0"><strong>آدرس:</strong> ${p.Pickup.Addr}</p>
                        </div>
                    `);

                // Destination marker
                L.marker(destLatLng, { icon: destinationIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <i class="bi bi-flag text-danger fs-5"></i>
                            <h6 class="fw-bold mt-1">مقصد مسافر ${index + 1}</h6>
                            <p class="mb-1"><strong>نام:</strong> ${p.Name}</p>
                            <p class="mb-0"><strong>آدرس:</strong> ${p.Dest.Addr}</p>
                        </div>
                    `);

                // Route line
                L.polyline([pickupLatLng, destLatLng], {
                    color: '#0d6efd',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '5, 5'
                }).addTo(map).bindPopup(`<strong>مسیر مسافر:</strong> ${p.Name}`);
            });

            if (passengers.length > 0) {
                const bounds = passengers.flatMap(p => [[p.Pickup.Lat, p.Pickup.Lng], [p.Dest.Lat, p.Dest.Lng]]);
                map.fitBounds(bounds, { padding: [40, 40] });
            }
        });
    </script>
}

<style>
    .table th, .table td {
        vertical-align: middle;
        text-align: center;
        padding: 0.75rem;
    }

    .badge {
        font-size: 0.8rem;
        padding: 0.4em 0.7em;
    }

    .card {
        margin-bottom: 1.5rem;
    }

    .custom-pickup-icon, .custom-dest-icon {
        background: transparent;
        border: none;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.1);
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }

    @@media (max-width: 768px) {
        .d-flex.justify-content-center {
            flex-direction: column !important;
            gap: 1rem !important;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .badge {
            font-size: 0.75rem;
        }
    }

    /* Animation for table rows */
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .table tbody tr {
        animation: fadeIn 0.3s ease-out;
    }
</style>