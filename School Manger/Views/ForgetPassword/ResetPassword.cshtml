@{
    ViewData["Title"] = "بازیابی رمز عبور";
    Layout = "_Layout";
}

<div class="container-fluid d-flex justify-content-center align-items-center vh-100 bg-dark" dir="rtl">
    <div class="card bg-black text-white border-primary shadow-lg" style="width: 100%; max-width: 500px; border-radius: 20px; border-width: 2px;">
        <div class="card-header bg-dark border-primary d-flex justify-content-between align-items-center py-3">
            <a asp-action="Index" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left-circle me-1"></i> بازگشت
            </a>
            <h5 class="m-0 fw-bold">
                <i class="bi bi-key-fill me-2"></i> بازیابی رمز عبور
            </h5>
        </div>

        <div class="card-body p-4">
            <div class="text-center mb-4">
                <i class="bi bi-shield-lock text-primary fs-1 mb-3 d-block"></i>
                <p class="text-white-50">لطفا رمز عبور جدید خود را وارد کنید</p>
            </div>

            <form asp-action="ResetPassword" method="post" id="resetPasswordForm">
                <input type="hidden" name="token" value="@Context.Request.Query["token"]" />
                <input type="hidden" name="email" value="@Context.Request.Query["email"]" />

                <div class="mb-4">
                    <label for="newPassword" class="form-label fw-semibold">
                        <i class="bi bi-lock me-1"></i> رمز عبور جدید
                    </label>
                    <div class="input-group">
                        <input type="password"
                               class="form-control bg-dark text-white border-primary"
                               id="newPassword"
                               name="newPassword"
                               placeholder="رمز عبور جدید (حداقل ۸ کاراکتر)"
                               required
                               minlength="8">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('newPassword', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div id="newPasswordHelp" class="form-text mt-2">
                        <i class="bi bi-info-circle me-1"></i> رمز عبور باید حداقل ۸ کاراکتر داشته باشد
                    </div>
                </div>

                <div class="mb-4">
                    <label for="confirmPassword" class="form-label fw-semibold">
                        <i class="bi bi-lock-fill me-1"></i> تکرار رمز عبور جدید
                    </label>
                    <div class="input-group">
                        <input type="password"
                               class="form-control bg-dark text-white border-primary"
                               id="confirmPassword"
                               name="confirmPassword"
                               placeholder="تکرار رمز عبور جدید"
                               required
                               minlength="8">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('confirmPassword', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div id="confirmPasswordHelp" class="form-text mt-2">
                        <i class="bi bi-info-circle me-1"></i> رمز عبور را مجددا وارد کنید
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                    <i class="bi bi-check-circle me-2"></i> تغییر رمز عبور
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const newPasswordHelp = document.getElementById('newPasswordHelp');
            const confirmPasswordHelp = document.getElementById('confirmPasswordHelp');

            // Validate new password
            newPasswordInput.addEventListener('input', function() {
                validatePassword(this, newPasswordHelp);
                validatePasswordMatch();
            });

            // Validate password confirmation
            confirmPasswordInput.addEventListener('input', validatePasswordMatch);

            function validatePassword(inputElement, helpElement) {
                const password = inputElement.value;

                if (password.length === 0) {
                    inputElement.classList.remove('border-success', 'border-danger', 'is-valid', 'is-invalid');
                    helpElement.innerHTML = '<i class="bi bi-info-circle me-1"></i> رمز عبور باید حداقل ۸ کاراکتر داشته باشد';
                    helpElement.className = 'form-text text-white-50 mt-2';
                    return false;
                }

                if (password.length < 8) {
                    inputElement.classList.remove('border-success', 'is-valid');
                    inputElement.classList.add('border-danger', 'is-invalid');
                    helpElement.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> رمز عبور باید حداقل ۸ کاراکتر داشته باشد';
                    helpElement.className = 'form-text text-danger mt-2';
                    return false;
                } else {
                    inputElement.classList.remove('border-danger', 'is-invalid');
                    inputElement.classList.add('border-success', 'is-valid');
                    helpElement.innerHTML = '<i class="bi bi-check-circle me-1"></i> رمز عبور معتبر است';
                    helpElement.className = 'form-text text-success mt-2';
                    return true;
                }
            }

            function validatePasswordMatch() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (confirmPassword.length === 0) {
                    confirmPasswordInput.classList.remove('border-success', 'border-danger', 'is-valid', 'is-invalid');
                    confirmPasswordHelp.innerHTML = '<i class="bi bi-info-circle me-1"></i> رمز عبور را مجددا وارد کنید';
                    confirmPasswordHelp.className = 'form-text text-white-50 mt-2';
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    confirmPasswordInput.classList.remove('border-success', 'is-valid');
                    confirmPasswordInput.classList.add('border-danger', 'is-invalid');
                    confirmPasswordHelp.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> رمزهای عبور مطابقت ندارند';
                    confirmPasswordHelp.className = 'form-text text-danger mt-2';
                    return false;
                } else if (newPassword.length >= 8) {
                    confirmPasswordInput.classList.remove('border-danger', 'is-invalid');
                    confirmPasswordInput.classList.add('border-success', 'is-valid');
                    confirmPasswordHelp.innerHTML = '<i class="bi bi-check-circle me-1"></i> رمزهای عبور مطابقت دارند';
                    confirmPasswordHelp.className = 'form-text text-success mt-2';
                    return true;
                }
                return false;
            }

            // Form submission validation
            document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
                const isNewPasswordValid = validatePassword(newPasswordInput, newPasswordHelp);
                const isPasswordMatchValid = validatePasswordMatch();

                if (!isNewPasswordValid || !isPasswordMatchValid) {
                    e.preventDefault();

                    if (!isNewPasswordValid) {
                        newPasswordInput.focus();
                    } else if (!isPasswordMatchValid) {
                        confirmPasswordInput.focus();
                    }

                    // Show error alert
                    const errorMessage = !isNewPasswordValid ?
                        'لطفا یک رمز عبور معتبر وارد کنید (حداقل ۸ کاراکتر)' :
                        'رمزهای عبور وارد شده مطابقت ندارند';

                    showAlert(errorMessage, 'danger');
                }
            });

            // Password strength indicator (optional enhancement)
            newPasswordInput.addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
        });

        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }

        function updatePasswordStrength(password) {
            // Optional: Add password strength meter
            const strengthMeter = document.getElementById('passwordStrength');
            if (!strengthMeter) return;

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;

            const strengthText = ['خیلی ضعیف', 'ضعیف', 'متوسط', 'قوی', 'خیلی قوی'];
            const strengthColors = ['danger', 'warning', 'info', 'primary', 'success'];

            strengthMeter.innerHTML = `
                <div class="progress mb-2" style="height: 5px;">
                    <div class="progress-bar bg-${strengthColors[strength]}" style="width: ${(strength + 1) * 20}%"></div>
                </div>
                <small class="text-${strengthColors[strength]}">${strengthText[strength]}</small>
            `;
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlert = document.querySelector('.alert-dismissible');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alert.innerHTML = `
                <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.querySelector('form').prepend(alert);
        }
    </script>
}

<style>
    /* Persian font support */
    body {
        font-family: 'B Nazanin', 'Nazanin', 'Tahoma', sans-serif;
    }

    /* Validation states */
    .is-valid {
        border-color: #28a745 !important;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    /* Input focus styling */
    .form-control:focus {
        background-color: #222;
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Password toggle button */
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    /* Smooth transitions */
    .form-control, .btn {
        transition: all 0.3s ease;
    }
</style>