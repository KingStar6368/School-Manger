@using School_Manger.Models.PageView
@{
    ViewData["Title"] = "انتخاب دو موقعیت مکانی";
    Layout = "_Layout";
}
@model ParentDashbordView

<div class="container-fluid d-flex justify-content-center align-items-center vh-100 bg-dark" dir="rtl">
    <div class="card bg-black text-white border-secondary" style="width: 100%;height:auto">
        <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
            <a asp-action="ParentMenu" class="btn btn-outline-light">
                <i class="bi bi-arrow-right me-1"></i> بازگشت
            </a>
            <h5 class="m-0">
                <i class="bi bi-geo-alt-fill text-primary me-2"></i>انتخاب موقعیت روی نقشه و مقصد
            </h5>
        </div>

        <form asp-action="AddChild" method="post">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8 mb-4 mb-md-0">
                        <!-- Map Container -->
                        <div id="map" style="height: 500px; width: 100%; border-radius: 8px;"></div>
                    </div>
                    <div class="col-md-4">
                        <!-- Search Section -->
                        <div class="mb-3">
                            <label for="locationSearch" class="form-label">
                                <i class="bi bi-search me-1"></i>جستجوی آدرس
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-white border-secondary">
                                    <i class="bi bi-geo"></i>
                                </span>
                                <input type="text"
                                       class="form-control bg-dark text-white border-secondary"
                                       id="locationSearch"
                                       placeholder="آدرس یا نام مکان">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Location 1 Section -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-alt text-success me-1"></i>موقعیت اول (مبدا)
                            </label>
                            <div id="location1Info" class="p-3 bg-dark border border-success rounded mb-2" style="min-height: 100px;">
                                <div class="text-center text-muted">
                                    <i class="bi bi-geo fs-4 d-block mb-2"></i>
                                    <p class="mb-1">موقعیت اول انتخاب نشده است</p>
                                    <small>روی نقشه کلیک کنید</small>
                                </div>
                            </div>
                        </div>

                        <!-- Location 2 Section -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-fill text-danger me-1"></i>موقعیت دوم (مقصد)
                            </label>
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-dark text-white border-secondary">
                                    <i class="bi bi-building"></i>
                                </span>
                                <select class="form-select bg-dark text-white border-secondary" id="location2Select">
                                    <option value="" selected>-- انتخاب مقصد --</option>
                                    @foreach (var school in Model.Schools)
                                    {
                                        <option value="@school.Id|@school.Address.Latitude,@school.Address.Longitude|@school.Name">
                                            @school.Name
                                        </option>
                                    }
                                    @if (Model.Schools == null || Model.Schools.Count == 0)
                                    {
                                        <option value="0|34.0918,49.6892|مدرسه نمونه اراک">مدرسه نمونه اراک</option>
                                        <option value="0|34.0854,49.7003|مدرسه شهید بهشتی اراک">مدرسه شهید بهشتی اراک</option>
                                        <option value="0|34.0789,49.6956|مدرسه علامه حلی اراک">مدرسه علامه حلی اراک</option>
                                        <option value="0|34.0723,49.6887|مدرسه فرزانگان اراک">مدرسه فرزانگان اراک</option>
                                        <option value="0|34.0801,49.6815|مدرسه انرژی اتمی اراک">مدرسه انرژی اتمی اراک</option>
                                    }
                                </select>
                            </div>
                            <input asp-for="SelectedChild.SchoolId" hidden id="SchoolRef" />
                            <div id="location2Info" class="p-3 bg-dark border border-danger rounded mb-3" style="min-height: 100px; display: none;">
                                <!-- اطلاعات موقعیت دوم اینجا نمایش داده می شود -->
                            </div>
                        </div>

                        <!-- Shift Selection -->
                        <div class="mb-3">
                            <label for="ShiftOption" class="form-label">
                                <i class="bi bi-clock text-warning me-1"></i>انتخاب شیفت
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-white border-secondary">
                                    <i class="bi bi-calendar-event"></i>
                                </span>
                                <select id="ShiftOption" name="SelectedChild.ShiftId" class="form-select bg-dark text-white border-secondary">
                                    <option value="">-- ابتدا مدرسه را انتخاب کنید --</option>
                                </select>
                            </div>
                            <input id="ShiftId" name="ShiftId" type="hidden" />
                        </div>

                        <!-- Hidden Form Fields -->
                        <div style="display: none;">
                            <input asp-for="SelectedChild.Path.Location1.Latitude" type="hidden" id="location1Lat">
                            <input asp-for="SelectedChild.Path.Location1.Longitude" type="hidden" id="location1Lng">
                            <input asp-for="SelectedChild.Path.Location1.Address" type="hidden" id="location1Address">

                            <input asp-for="SelectedChild.Path.Location2.Latitude" type="hidden" id="location2Lat">
                            <input asp-for="SelectedChild.Path.Location2.Longitude" type="hidden" id="location2Lng">
                            <input asp-for="SelectedChild.Path.Location2.Address" type="hidden" id="location2Address">

                            <input asp-for="SelectedChild.FirstName" value="@Model.SelectedChild.FirstName" type="hidden" />
                            <input asp-for="SelectedChild.LastName" value="@Model.SelectedChild.LastName" type="hidden" />
                            <input asp-for="SelectedChild.Class" value="@Model.SelectedChild.Class" type="hidden" />
                            <input asp-for="SelectedChild.NationalCode" value="@Model.SelectedChild.NationalCode" type="hidden" />
                            <input asp-for="SelectedChild.BirthDate" value="@Model.SelectedChild.BirthDate" type="hidden" />
                            <input id="PickTime1" asp-for="SelectedChild.Path.PickTime1" type="hidden" />
                            <input id="PickTime2" asp-for="SelectedChild.Path.PickTime2" type="hidden" />
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" id="confirmLocations" class="btn btn-primary py-2" disabled>
                                <i class="bi bi-check-circle me-2"></i> تایید موقعیت‌ها
                            </button>
                            <button id="clearLocations" class="btn btn-outline-danger py-2">
                                <i class="bi bi-x-circle me-2"></i> پاک کردن انتخاب‌ها
                            </button>
                        </div>

                        <!-- Instructions -->
                        <div class="mt-3 p-3 bg-dark border border-info rounded">
                            <h6 class="text-info mb-2">
                                <i class="bi bi-info-circle me-1"></i>راهنما:
                            </h6>
                            <ul class="small mb-0">
                                <li>روی نقشه کلیک کنید تا موقعیت مبدا انتخاب شود</li>
                                <li>مدرسه مقصد را از لیست انتخاب کنید</li>
                                <li>شیفت مورد نظر را انتخاب کنید</li>
                                <li>روی دکمه تایید موقعیت‌ها کلیک کنید</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Persian font and RTL support */
        body {
            font-family: 'B Nazanin', 'Nazanin', 'Tahoma', sans-serif;
        }

        /* Map styling */
        .leaflet-container {
            background-color: #121212 !important;
        }

        /* Custom marker icons */
        .location1-marker {
            background-color: #28a745;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .location2-marker {
            background-color: #dc3545;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Custom dark popup */
        .leaflet-popup-content {
            color: #fff;
            background-color: #222;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'B Nazanin', 'Nazanin', 'Tahoma', sans-serif;
        }

        /* Back button icon flip for RTL */
        .bi-arrow-right {
            transform: scaleX(-1);
        }

        /* Location info boxes */
        #location1Info, #location2Info {
            transition: all 0.3s ease;
        }

            #location1Info:hover, #location2Info:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

        /* Button hover effects */
        .btn {
            transition: all 0.3s ease;
        }

            .btn:hover {
                transform: translateY(-2px);
            }
    </style>
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map
        const map = L.map('map').setView([34.0918, 49.6892], 13); // مرکزیت اراک

        // تغییر لایه نقشه از تاریک به روشن
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Variables to store locations
        let location1 = null;
        let location2 = null;
        let location1Marker = null;
        let location2Marker = null;

        // Handle map click (only for location1 now)
        map.on('click', function(e) {
            // Set location 1
            if (location1Marker) {
                map.removeLayer(location1Marker);
            }

            location1 = {
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                address: 'در حال دریافت آدرس...'
            };

            // Create custom marker for location 1
            location1Marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'location1-marker',
                    html: '<i class="bi bi-house-fill" style="font-size: 10px;"></i>',
                    iconSize: [24, 24]
                })
            }).addTo(map)
            .bindPopup('<div class="text-center"><i class="bi bi-house-fill text-success me-1"></i><strong>موقعیت اول (مبدا)</strong></div>')
            .openPopup();

            updateLocationDisplay();
            getAddressFromCoordinates(e.latlng.lat, e.latlng.lng, 1);
        });

        // Handle location2 select change
        document.getElementById('location2Select').addEventListener('change', function() {
            const selectedValue = this.value;
            const shiftSelect = document.getElementById('ShiftOption');

            // Clear previous shifts
            shiftSelect.innerHTML = '<option value="">-- ابتدا مدرسه را انتخاب کنید --</option>';

            if (selectedValue) {
                const [Id, coords, address] = selectedValue.split('|');
                const [lat, lng] = coords.split(',');

                location2 = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    address: address
                };

                // Remove previous marker if exists
                if (location2Marker) {
                    map.removeLayer(location2Marker);
                }

                // Add new marker
                location2Marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'location2-marker',
                        html: '<i class="bi bi-building-fill" style="font-size: 10px;"></i>',
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                .bindPopup('<div class="text-center"><i class="bi bi-building-fill text-danger me-1"></i><strong>موقعیت دوم (مقصد)</strong></div>')
                .openPopup();

                // Update display
                document.getElementById('SchoolRef').value = Id;
                document.getElementById('location2Info').style.display = 'block';
                document.getElementById('location2Info').innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-building-fill text-danger fs-4 d-block mb-2"></i>
                        <p class="mb-1"><strong>موقعیت دوم:</strong></p>
                        <p class="mb-1"><small><i class="bi bi-geo me-1"></i>${address}</small></p>
                        <p class="mb-0"><small><i class="bi bi-geo-alt me-1"></i>عرض: ${lat}</small></p>
                        <p class="mb-0"><small><i class="bi bi-geo-alt me-1"></i>طول: ${lng}</small></p>
                    </div>
                `;

                // Update hidden fields
                document.getElementById('location2Lat').value = lat;
                document.getElementById('location2Lng').value = lng;
                document.getElementById('location2Address').value = address;

                // Fetch shifts for selected school
                GetShifts(parseInt(Id));

                // Enable confirm button if both locations are selected
                if (location1 && location2) {
                    document.getElementById('confirmLocations').disabled = false;
                }
            } else {
                // Clear location2 if nothing selected
                if (location2Marker) {
                    map.removeLayer(location2Marker);
                    location2Marker = null;
                }
                location2 = null;
                document.getElementById('location2Info').style.display = 'none';
                document.getElementById('confirmLocations').disabled = true;

                // Clear hidden fields
                document.getElementById('location2Lat').value = '';
                document.getElementById('location2Lng').value = '';
                document.getElementById('location2Address').value = '';
            }
        });

        function GetShifts(schoolId) {
            const shiftSelect = document.getElementById('ShiftOption');
            shiftSelect.innerHTML = '<option value="">در حال دریافت شیفت‌ها...</option>';

            fetch(`/Home/GetSchoolShifts?SchoolId=${schoolId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Received shifts data:', data);
                    shiftSelect.innerHTML = '<option value="">-- شیفت را انتخاب کنید --</option>';

                    if (data && data.length > 0) {
                        data.forEach(shift => {
                            const option = document.createElement('option');
                            option.value = shift.id+"|"+shift.start+"|"+shift.end;
                            option.textContent = `${shift.name} (${shift.start} - ${shift.end})`;
                            shiftSelect.appendChild(option);
                        });
                    } else {
                        shiftSelect.innerHTML = '<option value=""><i class="bi bi-exclamation-triangle me-1"></i>شیفتی برای این مدرسه یافت نشد</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching shifts:', error);
                    shiftSelect.innerHTML = '<option value=""><i class="bi bi-x-circle me-1"></i>خطا در دریافت شیفت‌ها</option>';
                });
        }

        // Update hidden shift field when shift selection changes
        document.getElementById('ShiftOption').addEventListener('change', function() {
            const [Id, Start, End] = document.getElementById('ShiftOption').value.split('|');
            document.getElementById('ShiftId').value = Id;
            document.getElementById('PickTime1').value = Start;
            document.getElementById('PickTime2').value = End;
        });

        // Function to get address from coordinates (using Nominatim)
        function getAddressFromCoordinates(lat, lng, locationNumber) {
            const apiKey = '7902de30b04b42558af4300bad6c27a0';
            fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}&language=fa`)
              .then(res => res.json())
              .then(data => {
                if (data.results && data.results.length > 0) {
                  const address = data.results[0].formatted;
                  location1.address = address;
                  updateLocationDisplay();
                }
              });
        }

        // Update location display
        function updateLocationDisplay() {
            const location1Div = document.getElementById('location1Info');

            if (location1) {
                location1Div.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-house-fill text-success fs-4 d-block mb-2"></i>
                        <p class="mb-1"><strong>موقعیت اول:</strong></p>
                        <p class="mb-1"><small><i class="bi bi-geo me-1"></i>${location1.address}</small></p>
                        <p class="mb-0"><small><i class="bi bi-geo-alt me-1"></i>عرض: ${location1.lat.toFixed(6)}</small></p>
                        <p class="mb-0"><small><i class="bi bi-geo-alt me-1"></i>طول: ${location1.lng.toFixed(6)}</small></p>
                    </div>
                `;

                // Update hidden fields
                document.getElementById('location1Lat').value = location1.lat;
                document.getElementById('location1Lng').value = location1.lng;
                document.getElementById('location1Address').value = location1.address;
            }

            // Enable confirm button if both locations are selected
            if (location1 && location2) {
                document.getElementById('confirmLocations').disabled = false;
            }
        }

        // Search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const query = document.getElementById('locationSearch').value;

            if (query.trim() === '') return;

            // Show loading state
            const searchBtn = this;
            const originalHtml = searchBtn.innerHTML;
            searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            searchBtn.disabled = true;

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const firstResult = data[0];
                        const lat = parseFloat(firstResult.lat);
                        const lng = parseFloat(firstResult.lon);

                        map.setView([lat, lng], 15);

                        // Add a temporary marker for search result
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'search-marker',
                                html: '<i class="bi bi-search" style="color: #007bff; font-size: 12px;"></i>',
                                iconSize: [20, 20]
                            })
                        }).addTo(map)
                        .bindPopup(`<div class="text-center"><i class="bi bi-search me-1"></i><strong>نتیجه جستجو</strong><br>${firstResult.display_name}</div>`)
                        .openPopup();
                    } else {
                        alert('مکانی یافت نشد');
                    }
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    alert('خطا در جستجوی مکان');
                })
                .finally(() => {
                    // Restore button state
                    searchBtn.innerHTML = originalHtml;
                    searchBtn.disabled = false;
                });
        });

        // Clear locations button
        document.getElementById('clearLocations').addEventListener('click', function(e) {
            e.preventDefault();

            // Remove markers
            if (location1Marker) {
                map.removeLayer(location1Marker);
                location1Marker = null;
            }
            if (location2Marker) {
                map.removeLayer(location2Marker);
                location2Marker = null;
            }

            // Reset locations
            location1 = null;
            location2 = null;
            document.getElementById('location2Select').value = '';
            document.getElementById('ShiftOption').innerHTML = '<option value="">-- ابتدا مدرسه را انتخاب کنید --</option>';

            // Update display
            document.getElementById('location1Info').innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-geo fs-4 d-block mb-2"></i>
                    <p class="mb-1">موقعیت اول انتخاب نشده است</p>
                    <small>روی نقشه کلیک کنید</small>
                </div>
            `;
            document.getElementById('location2Info').style.display = 'none';

            // Clear hidden fields
            document.getElementById('location1Lat').value = '';
            document.getElementById('location1Lng').value = '';
            document.getElementById('location1Address').value = '';
            document.getElementById('location2Lat').value = '';
            document.getElementById('location2Lng').value = '';
            document.getElementById('location2Address').value = '';
            document.getElementById('ShiftId').value = '';
            document.getElementById('PickTime1').value = '';
            document.getElementById('PickTime2').value = '';

            // Disable confirm button
            document.getElementById('confirmLocations').disabled = true;
        });

        // Confirm locations button
        document.getElementById('confirmLocations').addEventListener('click', function(e) {
            const shiftSelect = document.getElementById('ShiftOption');

            // Check if both locations are selected and shift is chosen
            if (!location1 || !location2) {
                alert("لطفاً موقعیت مبدا و مقصد را انتخاب کنید");
                e.preventDefault();
                return;
            }

            if (!shiftSelect.value) {
                alert("لطفاً شیفت را انتخاب کنید");
                e.preventDefault();
                return;
            }

            // Show loading state
            const confirmBtn = this;
            const originalHtml = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>در حال ثبت...';
            confirmBtn.disabled = true;
            document.querySelector('form').submit();
        });
    </script>
}