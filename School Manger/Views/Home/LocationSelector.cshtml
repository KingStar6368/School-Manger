@using School_Manger.Models.ParentViews
@{
    ViewData["Title"] = "انتخاب دو موقعیت مکانی";
    Layout = "_Layout";
}
@model ParentDashbordView

<div class="container-fluid d-flex justify-content-center align-items-center vh-100 bg-dark" dir="rtl">
    <div class="card bg-black text-white border-secondary" style="width: 100%;height:auto">
        <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
            <a asp-action="ParentMenu" class="btn btn-outline-light">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
            <h5 class="m-0">انتخاب موقعیت روی نقشه و مقصد</h5>
        </div>

        <form asp-action="AddChild" method="post">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8 mb-4 mb-md-0">
                        <!-- Map Container -->
                        <div id="map" style="height: 500px; width: 100%; border-radius: 8px;"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="locationSearch" class="form-label">جستجوی آدرس</label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control bg-dark text-white border-secondary"
                                       id="locationSearch"
                                       placeholder="آدرس یا نام مکان">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">موقعیت اول (روی نقشه انتخاب کنید):</label>
                            <div id="location1Info" class="p-3 bg-success rounded mb-2" style="min-height: 100px;">
                                <p class="text-muted mb-1">موقعیت اول انتخاب نشده است</p>
                            </div>

                            <label class="form-label">موقعیت دوم (مقصد):</label>
                            <select class="form-select bg-dark text-white border-secondary mb-3" id="location2Select">
                                <option value="" selected>-- انتخاب مقصد --</option>
                                <option value="34.0918,49.6892|مدرسه نمونه اراک">مدرسه نمونه اراک</option>
                                <option value="34.0854,49.7003|مدرسه شهید بهشتی اراک">مدرسه شهید بهشتی اراک</option>
                                <option value="34.0789,49.6956|مدرسه علامه حلی اراک">مدرسه علامه حلی اراک</option>
                                <option value="34.0723,49.6887|مدرسه فرزانگان اراک">مدرسه فرزانگان اراک</option>
                                <option value="34.0801,49.6815|مدرسه انرژی اتمی اراک">مدرسه انرژی اتمی اراک</option>
                            </select>

                            <div id="location2Info" class="p-3 bg-danger rounded mb-3" style="min-height: 100px; display: none;">
                                <!-- اطلاعات موقعیت دوم اینجا نمایش داده می شود -->
                            </div>

                            @* Data *@
                            <input asp-for="SelectedChild.Path.Location1.Latitude" type="hidden" id="location1Lat">
                            <input asp-for="SelectedChild.Path.Location1.Longitude" type="hidden" id="location1Lng">
                            <input asp-for="SelectedChild.Path.Location1.Address" type="hidden" id="location1Address">

                            <input asp-for="SelectedChild.Path.Location2.Latitude" type="hidden" id="location2Lat">
                            <input asp-for="SelectedChild.Path.Location2.Longitude" type="hidden" id="location2Lng">
                            <input asp-for="SelectedChild.Path.Location2.Address" type="hidden" id="location2Address">

                            <input asp-for="SelectedChild.FirstName" value="@Model.SelectedChild.FirstName" type="hidden" />
                            <input asp-for="SelectedChild.LastName" value="@Model.SelectedChild.LastName" type="hidden" />
                            <input asp-for="SelectedChild.Class" value="@Model.SelectedChild.Class" type="hidden" />
                            <input asp-for="SelectedChild.NationalCode" value="@Model.SelectedChild.NationalCode" type="hidden" />
                            <input asp-for="SelectedChild.BirthDate" value="@Model.SelectedChild.BirthDate" type="hidden" />
                            <input asp-for="SelectedChild.Path.PickTime1" value="@Model.SelectedChild.Path.PickTime1" type="hidden" />
                            <input asp-for="SelectedChild.Path.PickTime2" value="@Model.SelectedChild.Path.PickTime2" type="hidden" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" id="confirmLocations" class="btn btn-primary py-2" disabled>
                                <i class="bi bi-check-circle"></i> تایید موقعیت‌ها
                            </button>
                            <button id="clearLocations" class="btn btn-outline-danger py-2">
                                <i class="bi bi-x-circle"></i> پاک کردن انتخاب‌ها
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Persian font and RTL support */
        body {
            font-family: 'B Nazanin', 'Nazanin', 'Tahoma', sans-serif;
        }

        /* Map styling */
        .leaflet-container {
            background-color: #121212 !important;
        }

        /* Custom marker icons */
        .location1-marker {
            background-color: #4CAF50;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        .location2-marker {
            background-color: #FF5722;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        /* Custom dark popup */
        .leaflet-popup-content {
            color: #fff;
            background-color: #222;
            padding: 1rem;
            border-radius: 5px;
        }

        /* Back button icon flip for RTL */
        .bi-arrow-right {
            transform: scaleX(-1);
        }
    </style>
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map
        const map = L.map('map').setView([34.0918, 49.6892], 13); // مرکزیت اراک

        // تغییر لایه نقشه از تاریک به روشن
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Variables to store locations
        let location1 = null;
        let location2 = null;
        let location1Marker = null;
        let location2Marker = null;

        // Handle map click (only for location1 now)
        map.on('click', function(e) {
            // Set location 1
            if (location1Marker) {
                map.removeLayer(location1Marker);
            }

            location1 = {
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                address: 'در حال دریافت آدرس...'
            };

            // Create custom marker for location 1
            location1Marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'location1-marker',
                    html: '1',
                    iconSize: [24, 24]
                })
            }).addTo(map)
            .bindPopup('<div class="bg-success">موقعیت اول (مبدا)</div>')
            .openPopup();

            updateLocationDisplay();
            getAddressFromCoordinates(e.latlng.lat, e.latlng.lng, 1);
        });

        // Handle location2 select change
        document.getElementById('location2Select').addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
                const [coords, address] = selectedValue.split('|');
                const [lat, lng] = coords.split(',');

                location2 = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    address: address
                };

                // Remove previous marker if exists
                if (location2Marker) {
                    map.removeLayer(location2Marker);
                }

                // Add new marker
                location2Marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'location2-marker',
                        html: '2',
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                .bindPopup('<div class="bg-danger">موقعیت دوم (مقصد)</div>')
                .openPopup();

                // Update display
                document.getElementById('location2Info').style.display = 'block';
                document.getElementById('location2Info').innerHTML = `
                    <p><strong>موقعیت دوم:</strong></p>
                    <p><small>عرض: ${lat}</small></p>
                    <p><small>طول: ${lng}</small></p>
                    <p><small>آدرس: ${address}</small></p>
                `;

                // Update hidden fields
                document.getElementById('location2Lat').value = lat;
                document.getElementById('location2Lng').value = lng;
                document.getElementById('location2Address').value = address;

                // Enable confirm button if both locations are selected
                if (location1 && location2) {
                    document.getElementById('confirmLocations').disabled = false;
                }
            } else {
                // Clear location2 if nothing selected
                if (location2Marker) {
                    map.removeLayer(location2Marker);
                    location2Marker = null;
                }
                location2 = null;
                document.getElementById('location2Info').style.display = 'none';
                document.getElementById('confirmLocations').disabled = true;

                // Clear hidden fields
                document.getElementById('location2Lat').value = '';
                document.getElementById('location2Lng').value = '';
                document.getElementById('location2Address').value = '';
            }
        });

        // Function to get address from coordinates (using Nominatim)
        function getAddressFromCoordinates(lat, lng, locationNumber) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        location1.address = data.display_name;
                        updateLocationDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error fetching address:', error);
                    location1.address = 'آدرس یافت نشد';
                    updateLocationDisplay();
                });
        }

        // Update location display
        function updateLocationDisplay() {
            const location1Div = document.getElementById('location1Info');

            if (location1) {
                location1Div.innerHTML = `
                    <p><strong>موقعیت اول:</strong></p>
                    <p><small>عرض: ${location1.lat.toFixed(6)}</small></p>
                    <p><small>طول: ${location1.lng.toFixed(6)}</small></p>
                    <p><small>آدرس: ${location1.address}</small></p>
                `;

                // Update hidden fields
                document.getElementById('location1Lat').value = location1.lat;
                document.getElementById('location1Lng').value = location1.lng;
                document.getElementById('location1Address').value = location1.address;
            }

            // Enable confirm button if both locations are selected
            if (location1 && location2) {
                document.getElementById('confirmLocations').disabled = false;
            }
        }

        // Search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const query = document.getElementById('locationSearch').value;

            if (query.trim() === '') return;

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const firstResult = data[0];
                        const lat = parseFloat(firstResult.lat);
                        const lng = parseFloat(firstResult.lon);

                        map.setView([lat, lng], 15);

                        // You can add this as location1 if needed
                    }
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    alert('خطا در جستجوی مکان');
                });
        });

        // Clear locations button
        document.getElementById('clearLocations').addEventListener('click', function(e) {
            e.preventDefault();

            // Remove markers
            if (location1Marker) {
                map.removeLayer(location1Marker);
                location1Marker = null;
            }
            if (location2Marker) {
                map.removeLayer(location2Marker);
                location2Marker = null;
            }

            // Reset locations
            location1 = null;
            location2 = null;
            document.getElementById('location2Select').value = '';

            // Update display
            document.getElementById('location1Info').innerHTML = '<p class="text-muted mb-1">موقعیت اول انتخاب نشده است</p>';
            document.getElementById('location2Info').style.display = 'none';

            // Clear hidden fields
            document.getElementById('location1Lat').value = '';
            document.getElementById('location1Lng').value = '';
            document.getElementById('location1Address').value = '';
            document.getElementById('location2Lat').value = '';
            document.getElementById('location2Lng').value = '';
            document.getElementById('location2Address').value = '';

            // Disable confirm button
            document.getElementById('confirmLocations').disabled = true;
        });

        // Confirm locations button
        document.getElementById('confirmLocations').addEventListener('click', function(e) {
            // Check if both locations are selected
            if (!location1 || !location2) {
                alert("لطفاً موقعیت مبدا و مقصد را انتخاب کنید");
                e.preventDefault();
            }
        });
    </script>
}