@{
    ViewData["Title"] = "انتخاب دو موقعیت مکانی";
    Layout = "_Layout";
}

<div class="container-fluid d-flex justify-content-center align-items-center vh-100 bg-dark" dir="rtl">
    <div class="card bg-black text-white border-secondary" style="width: 100%;height:auto">
        <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
            <a href="@Url.Action("PreviousStep", "Auth")" class="btn btn-outline-light">
                <i class="bi bi-arrow-right"></i> بازگشت
            </a>
            <h5 class="m-0">انتخاب دو موقعیت روی نقشه</h5>
        </div>

        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-8 mb-4 mb-md-0">
                    <!-- Map Container -->
                    <div id="map" style="height: 500px; width: 100%; border-radius: 8px;"></div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="locationSearch" class="form-label">جستجوی آدرس</label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control bg-dark text-white border-secondary"
                                   id="locationSearch"
                                   placeholder="آدرس یا نام مکان">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">موقعیت اول:</label>
                        <div id="location1Info" class="p-3 bg-success rounded mb-2" style="min-height: 100px;">
                            <p class="text-muted mb-1">موقعیت اول انتخاب نشده است</p>
                        </div>

                        <label class="form-label">موقعیت دوم:</label>
                        <div id="location2Info" class="p-3 bg-danger rounded mb-3" style="min-height: 100px;">
                            <p class="text-muted mb-1">موقعیت دوم انتخاب نشده است</p>
                        </div>

                        <input type="hidden" id="location1Lat" name="location1Lat">
                        <input type="hidden" id="location1Lng" name="location1Lng">
                        <input type="hidden" id="location1Address" name="location1Address">

                        <input type="hidden" id="location2Lat" name="location2Lat">
                        <input type="hidden" id="location2Lng" name="location2Lng">
                        <input type="hidden" id="location2Address" name="location2Address">
                    </div>

                    <div class="d-grid gap-2">
                        <button id="confirmLocations" class="btn btn-primary py-2" disabled>
                            <i class="bi bi-check-circle"></i> تایید موقعیت‌ها
                        </button>
                        <button id="clearLocations" class="btn btn-outline-danger py-2">
                            <i class="bi bi-x-circle"></i> پاک کردن انتخاب‌ها
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Persian font and RTL support */
        body {
            font-family: 'B Nazanin', 'Nazanin', 'Tahoma', sans-serif;
        }

        /* Map styling */
        .leaflet-container {
            background-color: #121212 !important;
        }

        /* Custom marker icons */
        .location1-marker {
            background-color: #4CAF50;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        .location2-marker {
            background-color: #FF5722;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        /* Custom dark popup */
        .leaflet-popup-content {
            color: #fff;
            background-color: #222;
            padding: 1rem;
            border-radius: 5px;
        }

        /* Back button icon flip for RTL */
        .bi-arrow-right {
            transform: scaleX(-1);
        }
    </style>
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map
        const map = L.map('map').setView([35.6892, 51.3890], 12); // Default to Tehran

        // Add dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Variables to store locations
        let location1 = null;
        let location2 = null;
        let location1Marker = null;
        let location2Marker = null;
        let currentSelection = 1; // 1 for location1, 2 for location2

        // Handle map click
        map.on('click', function(e) {
            if (currentSelection === 1) {
                // Set location 1
                if (location1Marker) {
                    map.removeLayer(location1Marker);
                }

                location1 = {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    address: 'در حال دریافت آدرس...'
                };

                // Create custom marker for location 1
                location1Marker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'location1-marker',
                        html: '1',
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                .bindPopup('<div class="bg-success">موقعیت اول</div>')
                .openPopup();

                updateLocationDisplay();
                getAddressFromCoordinates(e.latlng.lat, e.latlng.lng, 1);

                // Switch to selecting location 2
                currentSelection = 2;
            } else {
                // Set location 2
                if (location2Marker) {
                    map.removeLayer(location2Marker);
                }

                location2 = {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    address: 'در حال دریافت آدرس...'
                };

                // Create custom marker for location 2
                location2Marker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'location2-marker',
                        html: '2',
                        iconSize: [24, 24]
                    })
                }).addTo(map)
                .bindPopup('<div class="bg-danger">موقعیت دوم</div>')
                .openPopup();

                updateLocationDisplay();
                getAddressFromCoordinates(e.latlng.lat, e.latlng.lng, 2);

                // Enable confirm button
                document.getElementById('confirmLocations').disabled = false;
            }
        });

        // Function to get address from coordinates (using Nominatim)
        function getAddressFromCoordinates(lat, lng, locationNumber) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        if (locationNumber === 1) {
                            location1.address = data.display_name;
                        } else {
                            location2.address = data.display_name;
                        }
                        updateLocationDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error fetching address:', error);
                    if (locationNumber === 1) {
                        location1.address = 'آدرس یافت نشد';
                    } else {
                        location2.address = 'آدرس یافت نشد';
                    }
                    updateLocationDisplay();
                });
        }

        // Update location display
        function updateLocationDisplay() {
            const location1Div = document.getElementById('location1Info');
            const location2Div = document.getElementById('location2Info');

            if (location1) {
                location1Div.innerHTML = `
                    <p><strong>موقعیت اول:</strong></p>
                    <p><small>عرض: ${location1.lat.toFixed(6)}</small></p>
                    <p><small>طول: ${location1.lng.toFixed(6)}</small></p>
                    <p><small>آدرس: ${location1.address}</small></p>
                `;

                // Update hidden fields
                document.getElementById('location1Lat').value = location1.lat;
                document.getElementById('location1Lng').value = location1.lng;
                document.getElementById('location1Address').value = location1.address;
            }

            if (location2) {
                location2Div.innerHTML = `
                    <p><strong>موقعیت دوم:</strong></p>
                    <p><small>عرض: ${location2.lat.toFixed(6)}</small></p>
                    <p><small>طول: ${location2.lng.toFixed(6)}</small></p>
                    <p><small>آدرس: ${location2.address}</small></p>
                `;

                // Update hidden fields
                document.getElementById('location2Lat').value = location2.lat;
                document.getElementById('location2Lng').value = location2.lng;
                document.getElementById('location2Address').value = location2.address;
            }

            // Enable confirm button if both locations are selected
            if (location1 && location2) {
                document.getElementById('confirmLocations').disabled = false;
            }
        }

        // Search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const query = document.getElementById('locationSearch').value;

            if (query.trim() === '') return;

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=fa`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const firstResult = data[0];
                        const lat = parseFloat(firstResult.lat);
                        const lng = parseFloat(firstResult.lon);

                        map.setView([lat, lng], 15);

                        // You can add this as a selected location if needed
                    }
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    alert('خطا در جستجوی مکان');
                });
        });

        // Clear locations button
        document.getElementById('clearLocations').addEventListener('click', function() {
            // Remove markers
            if (location1Marker) {
                map.removeLayer(location1Marker);
                location1Marker = null;
            }
            if (location2Marker) {
                map.removeLayer(location2Marker);
                location2Marker = null;
            }

            // Reset locations
            location1 = null;
            location2 = null;
            currentSelection = 1;

            // Update display
            document.getElementById('location1Info').innerHTML = '<p class="text-muted mb-1">موقعیت اول انتخاب نشده است</p>';
            document.getElementById('location2Info').innerHTML = '<p class="text-muted mb-1">موقعیت دوم انتخاب نشده است</p>';

            // Clear hidden fields
            document.getElementById('location1Lat').value = '';
            document.getElementById('location1Lng').value = '';
            document.getElementById('location1Address').value = '';
            document.getElementById('location2Lat').value = '';
            document.getElementById('location2Lng').value = '';
            document.getElementById('location2Address').value = '';

            // Disable confirm button
            document.getElementById('confirmLocations').disabled = true;
        });

        // Confirm locations button
              // Confirm locations button - Updated version
                document.getElementById('confirmLocations').addEventListener('click', function() {
            // Check if both locations are selected
            if (!location1 || !location2) {
                alert("لطفاً هر دو موقعیت را انتخاب کنید");
                return;
            }

            // Create a form element
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Home/AddChild';

            // Helper function to add hidden fields
            function addField(name, value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }

            // Add location 1 data
            addField('Location1.Latitude', location1.lat);
            addField('Location1.Longitude', location1.lng);
            addField('Location1.Address', location1.address);

            // Add location 2 data
            addField('Location2.Latitude', location2.lat);
            addField('Location2.Longitude', location2.lng);
            addField('Location2.Address', location2.address);

            // Submit the form
            document.body.appendChild(form);
            form.submit();
        });
    </script>
}